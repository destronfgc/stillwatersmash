<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #1a1b26; color: #c0caf5; }
        .control-card { background-color: #24283b; border-radius: 0.5rem; padding: 1.5rem; border: 1px solid #414868; }
        .input-field { background-color: #1a1b26; border: 1px solid #414868; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; color: #c0caf5; }
        .btn { border-radius: 0.375rem; padding: 0.5rem 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #7aa2f7; color: #1a1b26; }
        .btn-primary:hover { background-color: #9dacff; }
        .btn-secondary { background-color: #bb9af7; color: #1a1b26; }
        .btn-secondary:hover { background-color: #d7c5ff; }
        .btn-danger { background-color: #f7768e; color: #1a1b26; }
        .btn-disabled { background-color: #414868; color: #787c99; cursor: not-allowed; }
        .startgg-btn { background-color: #CB333B; color: white; }
        .startgg-btn:hover { background-color: #E04A53; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white">Overlay Control Panel</h1>
            <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 bg-gray-700 rounded-full text-sm">
                <span id="status-dot" class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                <span id="status-text">Connecting...</span>
            </div>
        </div>

        <!-- NEW: Start.gg Integration Card -->
        <div id="startgg-card" class="control-card">
            <h2 class="text-xl font-bold text-white mb-4">Start.gg Integration</h2>
            <div id="startgg-signin-view">
                <p class="mb-4">Sign in with your start.gg account to fetch tournament data automatically.</p>
                <button id="signin-btn" class="btn startgg-btn">Sign in with start.gg</button>
            </div>
            <div id="startgg-control-view" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <p>Signed in as: <strong id="username-display"></strong></p>
                    <button id="signout-btn" class="text-sm text-red-400 hover:underline">Sign out</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                    <div>
                        <label for="tournamentSlug" class="text-sm font-medium">Tournament Slug</label>
                        <input type="text" id="tournamentSlug" class="input-field mt-1" placeholder="e.g., genesis-x">
                    </div>
                    <div>
                        <label for="streamQueue" class="text-sm font-medium">Stream Name / Station</label>
                        <input type="text" id="streamQueue" class="input-field mt-1" placeholder="e.g., TNS_1">
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-4">
                     <button id="fetch-match-btn" class="btn btn-secondary">Fetch Current Match</button>
                     <div id="fetch-status" class="text-sm text-gray-400"></div>
                </div>
            </div>
        </div>
        
        <!-- Manual Controls -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Player 1 -->
            <div class="control-card space-y-4">
                <h2 class="text-xl font-bold text-orange-400">Player 1</h2>
                <div>
                    <label for="p1Sponsor" class="text-sm font-medium">Sponsor</label>
                    <input type="text" id="p1Sponsor" class="input-field mt-1">
                </div>
                <div>
                    <label for="p1Tag" class="text-sm font-medium">Tag</label>
                    <input type="text" id="p1Tag" class="input-field mt-1">
                </div>
                 <div>
                    <label for="p1Pronouns" class="text-sm font-medium">Pronouns</label>
                    <input type="text" id="p1Pronouns" class="input-field mt-1">
                </div>
                <div>
                    <label for="p1Status" class="text-sm font-medium">Status (L/W)</label>
                    <input type="text" id="p1Status" class="input-field mt-1">
                </div>
                <div class="flex items-center gap-4">
                    <label class="text-sm font-medium">Score</label>
                    <button id="p1-score-minus" class="btn btn-danger w-10">-</button>
                    <span id="p1-score-display" class="text-2xl font-bold w-8 text-center">0</span>
                    <button id="p1-score-plus" class="btn btn-primary w-10">+</button>
                </div>
                <div>
                    <label for="p1Character" class="text-sm font-medium">Character</label>
                    <select id="p1Character" class="input-field mt-1"></select>
                </div>
            </div>

            <!-- Match Info -->
            <div class="control-card space-y-4">
                <h2 class="text-xl font-bold text-white">Match Info</h2>
                 <div>
                    <label for="round" class="text-sm font-medium">Round</label>
                    <input type="text" id="round" class="input-field mt-1">
                </div>
                <div>
                    <label for="formatType" class="text-sm font-medium">Format</label>
                    <div class="flex items-center gap-2 mt-1">
                         <select id="formatType" class="input-field">
                             <option>Best of</option>
                             <option>First to</option>
                         </select>
                         <input type="number" id="formatNumber" class="input-field w-24" value="5">
                    </div>
                </div>
                <div class="pt-4 space-y-4">
                    <button id="swap-btn" class="btn btn-secondary w-full">Swap Players</button>
                    <button id="update-btn" class="btn btn-primary w-full">Force Update</button>
                </div>
            </div>

            <!-- Player 2 -->
            <div class="control-card space-y-4">
                 <h2 class="text-xl font-bold text-gray-400">Player 2</h2>
                 <div>
                    <label for="p2Sponsor" class="text-sm font-medium">Sponsor</label>
                    <input type="text" id="p2Sponsor" class="input-field mt-1">
                </div>
                <div>
                    <label for="p2Tag" class="text-sm font-medium">Tag</label>
                    <input type="text" id="p2Tag" class="input-field mt-1">
                </div>
                <div>
                    <label for="p2Pronouns" class="text-sm font-medium">Pronouns</label>
                    <input type="text" id="p2Pronouns" class="input-field mt-1">
                </div>
                <div>
                    <label for="p2Status" class="text-sm font-medium">Status (L/W)</label>
                    <input type="text" id="p2Status" class="input-field mt-1">
                </div>
                 <div class="flex items-center gap-4">
                    <label class="text-sm font-medium">Score</label>
                    <button id="p2-score-minus" class="btn btn-danger w-10">-</button>
                    <span id="p2-score-display" class="text-2xl font-bold w-8 text-center">0</span>
                    <button id="p2-score-plus" class="btn btn-primary w-10">+</button>
                </div>
                <div>
                    <label for="p2Character" class="text-sm font-medium">Character</label>
                    <select id="p2Character" class="input-field mt-1"></select>
                </div>
            </div>
        </div>
    </div>
    
    <script src="./firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- CONFIGURATION ---
        const CLIENT_ID = '302'; // Your start.gg application Client ID
        const REDIRECT_URI = 'https://graceful-banoffee-954c8d.netlify.app/auth-callback.html';
        const STARTGG_API_URL = 'https://api.start.gg/gql/alpha';
        
        let accessToken = null;

        // --- CHARACTER LIST ---
        const characters = ["Banjo & Kazooie", "Bayonetta", "Bowser", "Bowser Jr.", "Byleth", "Captain Falcon", "Chrom", "Cloud", "Corrin", "Daisy", "Dark Pit", "Dark Samus", "Diddy Kong", "Donkey Kong", "Dr. Mario", "Duck Hunt", "Falco", "Fox", "Ganondorf", "Greninja", "Hero", "Ice Climbers", "Ike", "Incineroar", "Inkling", "Isabelle", "Jigglypuff", "Joker", "Kazuya", "Ken", "King Dedede", "King K. Rool", "Kirby", "Link", "Little Mac", "Lucario", "Lucas", "Lucina", "Luigi", "Mario", "Marth", "Mega Man", "Meta Knight", "Mewtwo", "Mii Brawler", "Mii Gunner", "Mii Swordfighter", "Min Min", "Mr. Game & Watch", "Ness", "Olimar", "Pac-Man", "Palutena", "Peach", "Pichu", "Pikachu", "Piranha Plant", "Pit", "Pokémon Trainer", "Pyra/Mythra", "Richter", "Ridley", "R.O.B.", "Robin", "Rosalina & Luma", "Roy", "Ryu", "Samus", "Sephiroth", "Sheik", "Shulk", "Simon", "Snake", "Sonic", "Sora", "Steve", "Terry", "Toon Link", "Villager", "Wario", "Wii Fit Trainer", "Wolf", "Yoshi", "Young Link", "Zelda", "Zero Suit Samus"];
        
        // --- DOM ELEMENTS ---
        const allInputs = ['p1Sponsor', 'p1Tag', 'p1Pronouns', 'p1Status', 'p2Sponsor', 'p2Tag', 'p2Pronouns', 'p2Status', 'round', 'formatType', 'formatNumber', 'p1Character', 'p2Character'];
        const elements = {};
        allInputs.forEach(id => elements[id] = document.getElementById(id));
        elements.p1ScoreDisplay = document.getElementById('p1-score-display');
        elements.p2ScoreDisplay = document.getElementById('p2-score-display');
        
        let p1Score = 0;
        let p2Score = 0;
        let db, auth, docRef;

        // --- UI MANAGEMENT ---
        function showSignedInView(username) {
            document.getElementById('startgg-signin-view').classList.add('hidden');
            document.getElementById('startgg-control-view').classList.remove('hidden');
            document.getElementById('username-display').textContent = username;
        }

        function showSignedOutView() {
            document.getElementById('startgg-signin-view').classList.remove('hidden');
            document.getElementById('startgg-control-view').classList.add('hidden');
        }

        // --- CORE FUNCTIONS ---
        function populateCharacters() {
            const createOption = (char) => `<option value="${char}">${char}</option>`;
            const options = characters.map(createOption).join('');
            elements.p1Character.innerHTML = `<option value="">Select Character</option>${options}`;
            elements.p2Character.innerHTML = `<option value="">Select Character</option>${options}`;
        }
        
        function updateUI(data) {
             allInputs.forEach(id => {
                if(elements[id] && data[id] !== undefined) elements[id].value = data[id];
            });
            p1Score = data.p1Score || 0;
            p2Score = data.p2Score || 0;
            elements.p1ScoreDisplay.textContent = p1Score;
            elements.p2ScoreDisplay.textContent = p2Score;
        }
        
        function sendUpdateToFirebase() {
            if (!docRef) return;
            const data = {};
            allInputs.forEach(id => data[id] = elements[id].value);
            data.p1Score = p1Score;
            data.p2Score = p2Score;
            
            setDoc(docRef, data, { merge: true })
                .then(() => setStatus('Saved', 'green'))
                .catch(error => {
                    console.error("Error writing document: ", error);
                    setStatus('Error', 'red');
                });
        }
        
        function setStatus(text, color) {
            document.getElementById('status-text').textContent = text;
            const dot = document.getElementById('status-dot');
            dot.className = `w-3 h-3 bg-${color}-500 rounded-full`;
        }

        // --- START.GG OAUTH & API LOGIC ---
        function handleSignIn() {
            const state = Math.random().toString(36).substring(2); // CSRF protection
            sessionStorage.setItem('oauth_state', state);
            const authUrl = `https://start.gg/oauth/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=user.identity&state=${state}`;
            window.open(authUrl, 'startgg-auth', 'width=600,height=700');
        }

        function handleSignOut() {
            accessToken = null;
            localStorage.removeItem('startGgToken');
            localStorage.removeItem('startGgUsername');
            showSignedOutView();
        }

        async function fetchStartGgUser(token) {
             const response = await fetch(STARTGG_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ query: `query { currentUser { gamerTag } }` }),
            });
            const json = await response.json();
            return json.data.currentUser.gamerTag;
        }

        async function fetchMatchFromQueue() {
            const slug = document.getElementById('tournamentSlug').value.trim();
            const queueName = document.getElementById('streamQueue').value.trim();
            const fetchStatus = document.getElementById('fetch-status');

            if (!slug || !queueName) {
                fetchStatus.textContent = "Slug and Stream Name are required.";
                return;
            }
             if (!accessToken) {
                fetchStatus.textContent = "You are not signed in.";
                return;
            }
            
            fetchStatus.textContent = 'Fetching...';

            const query = `
                query StreamQueueOnTournament($slug: String!) {
                  tournament(slug: $slug) {
                    streamQueue {
                      stream { streamName }
                      sets {
                        id
                        fullRoundText
                        slots {
                          entrant {
                            id
                            participants { gamerTag prefix }
                          }
                        }
                      }
                    }
                  }
                }`;
            
            try {
                const response = await fetch(STARTGG_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                    body: JSON.stringify({ query, variables: { slug } }),
                });

                const json = await response.json();
                if (json.errors) throw new Error(json.errors.map(e => e.message).join(', '));

                const streamQueue = json.data.tournament.streamQueue;
                if (!streamQueue) throw new Error("No stream queue found.");

                const targetStream = streamQueue.find(q => q.stream && q.stream.streamName.toLowerCase() === queueName.toLowerCase());
                if (!targetStream || !targetStream.sets || targetStream.sets.length === 0) {
                    throw new Error(`No sets found on queue "${queueName}".`);
                }

                const match = targetStream.sets[0];
                const p1 = match.slots[0].entrant.participants[0];
                const p2 = match.slots[1].entrant.participants[0];

                elements.p1Tag.value = p1.gamerTag;
                elements.p1Sponsor.value = p1.prefix || '';
                elements.p2Tag.value = p2.gamerTag;
                elements.p2Sponsor.value = p2.prefix || '';
                elements.round.value = match.fullRoundText;
                
                // Clear other fields
                ['p1Pronouns', 'p1Status', 'p2Pronouns', 'p2Status'].forEach(id => elements[id].value = '');
                p1Score = 0; p2Score = 0;
                elements.p1ScoreDisplay.textContent = '0';
                elements.p2ScoreDisplay.textContent = '0';
                elements.p1Character.value = '';
                elements.p2Character.value = '';

                fetchStatus.textContent = `Loaded: ${p1.gamerTag} vs ${p2.gamerTag}`;
                sendUpdateToFirebase();
            } catch (error) {
                console.error("start.gg fetch error:", error);
                fetchStatus.textContent = `Error: ${error.message}`;
            }
        }
        
        // --- MAIN APP LOGIC & EVENT LISTENERS ---
        async function main() {
            populateCharacters();
            
            // Handle the auth callback from the popup
            window.addEventListener('message', async (event) => {
                if (event.data.type === 'authSuccess') {
                    accessToken = event.data.token;
                    localStorage.setItem('startGgToken', accessToken);
                    try {
                        const username = await fetchStartGgUser(accessToken);
                        localStorage.setItem('startGgUsername', username);
                        showSignedInView(username);
                    } catch (e) {
                        console.error("Failed to fetch user after login", e);
                        handleSignOut();
                    }
                } else if (event.data.type === 'authError') {
                    console.error("Authentication failed:", event.data.error);
                }
            });

            // Check for existing token on page load
            const savedToken = localStorage.getItem('startGgToken');
            const savedUsername = localStorage.getItem('startGgUsername');
            if (savedToken && savedUsername) {
                accessToken = savedToken;
                showSignedInView(savedUsername);
            } else {
                showSignedOutView();
            }

            // --- Event Listeners ---
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            document.getElementById('fetch-match-btn').addEventListener('click', fetchMatchFromQueue);

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            const appId = 'stillwater-smash-overlay';
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    setStatus('Connected', 'green');
                    docRef = doc(db, "overlays", appId);
                    onSnapshot(docRef, (doc) => { if (doc.exists()) { updateUI(doc.data()); } });
                } else {
                    setStatus('Authenticating...', 'yellow');
                    signInAnonymously(auth).catch(error => { console.error("Anonymous sign-in failed:", error); setStatus('Auth Error', 'red'); });
                }
            });
            
            document.getElementById('update-btn').addEventListener('click', sendUpdateToFirebase);
            document.getElementById('swap-btn').addEventListener('click', () => {
                const p1Data = {}, p2Data = {};
                ['Sponsor', 'Tag', 'Pronouns', 'Status', 'Character'].forEach(field => {
                    const p1Id = `p1${field}`; const p2Id = `p2${field}`;
                    p1Data[p1Id] = elements[p1Id].value; p2Data[p2Id] = elements[p2Id].value;
                });
                const tempP1Score = p1Score; p1Score = p2Score; p2Score = tempP1Score;

                Object.keys(p1Data).forEach(p1Id => {
                    const p2Id = p1Id.replace('p1', 'p2');
                    elements[p1Id].value = p2Data[p2Id];
                    elements[p2Id].value = p1Data[p1Id];
                });
                elements.p1ScoreDisplay.textContent = p1Score;
                elements.p2ScoreDisplay.textContent = p2Score;
                sendUpdateToFirebase();
            });
            
            document.getElementById('p1-score-plus').addEventListener('click', () => { p1Score++; elements.p1ScoreDisplay.textContent = p1Score; sendUpdateToFirebase(); });
            document.getElementById('p1-score-minus').addEventListener('click', () => { if (p1Score > 0) p1Score--; elements.p1ScoreDisplay.textContent = p1Score; sendUpdateToFirebase(); });
            document.getElementById('p2-score-plus').addEventListener('click', () => { p2Score++; elements.p2ScoreDisplay.textContent = p2Score; sendUpdateToFirebase(); });
            document.getElementById('p2-score-minus').addEventListener('click', () => { if (p2Score > 0) p2Score--; elements.p2ScoreDisplay.textContent = p2Score; sendUpdateToFirebase(); });
            
            allInputs.forEach(id => elements[id]?.addEventListener('change', sendUpdateToFirebase));
        }
        
        main();
    </script>
</body>
</html>


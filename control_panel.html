<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #2d3748;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .input-field {
            background-color: #4a5568;
            border: 1px solid #718096;
            color: #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #4299e1;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3182ce;
        }
        .btn-secondary {
            background-color: #f6e05e;
            color: #424242;
        }
        .btn-secondary:hover {
            background-color: #f59e0b;
        }
        .score-btn {
            background-color: #4a5568;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-white">Overlay Control Panel</h1>
        <div id="status" class="flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-semibold">
            <span id="status-indicator" class="w-3 h-3 rounded-full"></span>
            <span id="status-text">Connecting...</span>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Player 1 Card -->
        <div class="card space-y-4">
            <h2 class="text-xl font-bold text-orange-400">Player 1</h2>
            <div>
                <label for="p1-sponsor" class="block text-sm font-medium mb-1">Sponsor</label>
                <input type="text" id="p1-sponsor" class="input-field" placeholder="Sponsor Tag">
            </div>
            <div>
                <label for="p1-tag" class="block text-sm font-medium mb-1">Tag</label>
                <input type="text" id="p1-tag" class="input-field" placeholder="Pistol Pete">
            </div>
            <div>
                <label for="p1-pronouns" class="block text-sm font-medium mb-1">Pronouns</label>
                <input type="text" id="p1-pronouns" class="input-field" placeholder="he/him">
            </div>
            <div>
                <label for="p1-status" class="block text-sm font-medium mb-1">Status (L/W)</label>
                <input type="text" id="p1-status" class="input-field" placeholder="Winners">
            </div>
            <div>
                <label for="p1-score" class="block text-sm font-medium mb-1">Score</label>
                <div class="flex items-center space-x-2">
                    <button id="p1-score-down" class="score-btn">-</button>
                    <input type="number" id="p1-score" class="input-field text-center" value="0">
                    <button id="p1-score-up" class="score-btn">+</button>
                </div>
            </div>
            <div>
                <label for="p1-character" class="block text-sm font-medium mb-1">Character</label>
                <select id="p1-character" class="input-field"></select>
            </div>
        </div>

        <!-- Match Info Card -->
        <div class="card space-y-4">
            <h2 class="text-xl font-bold text-white">Match Info</h2>
            <div>
                <label for="round" class="block text-sm font-medium mb-1">Round</label>
                <input type="text" id="round" class="input-field" placeholder="Grand Finals">
            </div>
            <div>
                <label for="format-type" class="block text-sm font-medium mb-1">Format</label>
                <div class="flex space-x-2">
                    <select id="format-type" class="input-field w-2/3">
                        <option>Best of</option>
                        <option>First to</option>
                    </select>
                    <input type="number" id="format-number" class="input-field w-1/3" placeholder="5">
                </div>
            </div>
            <button id="swap-players" class="btn btn-secondary w-full">Swap Players</button>
            <button id="force-update" class="btn btn-primary w-full">Force Update</button>
        </div>

        <!-- Player 2 Card -->
        <div class="card space-y-4">
            <h2 class="text-xl font-bold text-blue-400">Player 2</h2>
            <div>
                <label for="p2-sponsor" class="block text-sm font-medium mb-1">Sponsor</label>
                <input type="text" id="p2-sponsor" class="input-field" placeholder="Sponsor Tag">
            </div>
            <div>
                <label for="p2-tag" class="block text-sm font-medium mb-1">Tag</label>
                <input type="text" id="p2-tag" class="input-field" placeholder="The Cowboy">
            </div>
            <div>
                <label for="p2-pronouns" class="block text-sm font-medium mb-1">Pronouns</label>
                <input type="text" id="p2-pronouns" class="input-field" placeholder="he/him">
            </div>
            <div>
                <label for="p2-status" class="block text-sm font-medium mb-1">Status (L/W)</label>
                <input type="text" id="p2-status" class="input-field" placeholder="Losers">
            </div>
            <div>
                <label for="p2-score" class="block text-sm font-medium mb-1">Score</label>
                <div class="flex items-center space-x-2">
                    <button id="p2-score-down" class="score-btn">-</button>
                    <input type="number" id="p2-score" class="input-field text-center" value="0">
                    <button id="p2-score-up" class="score-btn">+</button>
                </div>
            </div>
            <div>
                <label for="p2-character" class="block text-sm font-medium mb-1">Character</label>
                <select id="p2-character" class="input-field"></select>
            </div>
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script src="./firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- CHARACTER DATA ---
        const characters = ["Mario", "Donkey Kong", "Link", "Samus", "Dark Samus", "Yoshi", "Kirby", "Fox", "Pikachu", "Luigi", "Ness", "Captain Falcon", "Jigglypuff", "Peach", "Daisy", "Bowser", "Ice Climbers", "Sheik", "Zelda", "Dr. Mario", "Pichu", "Falco", "Marth", "Lucina", "Young Link", "Ganondorf", "Mewtwo", "Roy", "Chrom", "Mr. Game & Watch", "Meta Knight", "Pit", "Dark Pit", "Zero Suit Samus", "Wario", "Snake", "Ike", "Pokemon Trainer", "Diddy Kong", "Lucas", "Sonic", "King Dedede", "Olimar", "Lucario", "R.O.B.", "Toon Link", "Wolf", "Villager", "Mega Man", "Wii Fit Trainer", "Rosalina & Luma", "Little Mac", "Greninja", "Mii Brawler", "Mii Swordfighter", "Mii Gunner", "Palutena", "Pac-Man", "Robin", "Shulk", "Bowser Jr.", "Duck Hunt", "Ryu", "Ken", "Cloud", "Corrin", "Bayonetta", "Inkling", "Ridley", "Simon", "Richter", "King K. Rool", "Isabelle", "Incineroar", "Piranha Plant", "Joker", "Hero", "Banjo & Kazooie", "Terry", "Byleth", "Min Min", "Steve", "Sephiroth", "Pyra/Mythra", "Kazuya", "Sora"];

        let db, auth;
        const appId = 'stillwater-smash-overlay';

        function setStatus(text, type) {
            const statusText = document.getElementById('status-text');
            const statusIndicator = document.getElementById('status-indicator');
            statusText.textContent = text;
            if (type === 'connecting') {
                statusIndicator.style.backgroundColor = '#f6e05e'; // yellow
            } else if (type === 'connected' || type === 'saved') {
                statusIndicator.style.backgroundColor = '#48bb78'; // green
            } else if (type === 'error') {
                statusIndicator.style.backgroundColor = '#f56565'; // red
            }
        }

        async function saveData() {
            if (!auth.currentUser) {
                console.error("Not authenticated");
                setStatus('Auth Error', 'error');
                return;
            }
            try {
                const docRef = doc(db, "overlays", appId);
                const data = {
                    p1Sponsor: document.getElementById('p1-sponsor').value,
                    p1Tag: document.getElementById('p1-tag').value,
                    p1Pronouns: document.getElementById('p1-pronouns').value,
                    p1Status: document.getElementById('p1-status').value,
                    p1Score: parseInt(document.getElementById('p1-score').value) || 0,
                    p1Character: document.getElementById('p1-character').value,
                    p2Sponsor: document.getElementById('p2-sponsor').value,
                    p2Tag: document.getElementById('p2-tag').value,
                    p2Pronouns: document.getElementById('p2-pronouns').value,
                    p2Status: document.getElementById('p2-status').value,
                    p2Score: parseInt(document.getElementById('p2-score').value) || 0,
                    p2Character: document.getElementById('p2-character').value,
                    round: document.getElementById('round').value,
                    formatType: document.getElementById('format-type').value,
                    formatNumber: document.getElementById('format-number').value,
                };
                await setDoc(docRef, data, { merge: true });
                setStatus('Saved', 'saved');
                 setTimeout(() => setStatus('Connected', 'connected'), 2000);
            } catch (error) {
                console.error("Error saving data: ", error);
                setStatus('Save Error', 'error');
            }
        }

        async function loadData() {
            const docRef = doc(db, "overlays", appId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('p1-sponsor').value = data.p1Sponsor || '';
                document.getElementById('p1-tag').value = data.p1Tag || '';
                document.getElementById('p1-pronouns').value = data.p1Pronouns || '';
                document.getElementById('p1-status').value = data.p1Status || '';
                document.getElementById('p1-score').value = data.p1Score || 0;
                document.getElementById('p1-character').value = data.p1Character || characters[0];
                document.getElementById('p2-sponsor').value = data.p2Sponsor || '';
                document.getElementById('p2-tag').value = data.p2Tag || '';
                document.getElementById('p2-pronouns').value = data.p2Pronouns || '';
                document.getElementById('p2-status').value = data.p2Status || '';
                document.getElementById('p2-score').value = data.p2Score || 0;
                document.getElementById('p2-character').value = data.p2Character || characters[0];
                document.getElementById('round').value = data.round || '';
                document.getElementById('format-type').value = data.formatType || 'Best of';
                document.getElementById('format-number').value = data.formatNumber || '';
            }
        }

        function swapPlayers() {
            const p1Sponsor = document.getElementById('p1-sponsor').value;
            const p1Tag = document.getElementById('p1-tag').value;
            const p1Pronouns = document.getElementById('p1-pronouns').value;
            const p1Status = document.getElementById('p1-status').value;
            const p1Score = document.getElementById('p1-score').value;
            const p1Character = document.getElementById('p1-character').value;

            const p2Sponsor = document.getElementById('p2-sponsor').value;
            const p2Tag = document.getElementById('p2-tag').value;
            const p2Pronouns = document.getElementById('p2-pronouns').value;
            const p2Status = document.getElementById('p2-status').value;
            const p2Score = document.getElementById('p2-score').value;
            const p2Character = document.getElementById('p2-character').value;
            
            document.getElementById('p1-sponsor').value = p2Sponsor;
            document.getElementById('p1-tag').value = p2Tag;
            document.getElementById('p1-pronouns').value = p2Pronouns;
            document.getElementById('p1-status').value = p2Status;
            document.getElementById('p1-score').value = p2Score;
            document.getElementById('p1-character').value = p2Character;

            document.getElementById('p2-sponsor').value = p1Sponsor;
            document.getElementById('p2-tag').value = p1Tag;
            document.getElementById('p2-pronouns').value = p1Pronouns;
            document.getElementById('p2-status').value = p1Status;
            document.getElementById('p2-score').value = p1Score;
            document.getElementById('p2-character').value = p1Character;

            saveData();
        }

        function setupEventListeners() {
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', saveData);
                el.addEventListener('keyup', saveData);
            });
            document.getElementById('force-update').addEventListener('click', saveData);
            document.getElementById('swap-players').addEventListener('click', swapPlayers);
            
            // Score buttons
            document.getElementById('p1-score-up').addEventListener('click', () => {
                document.getElementById('p1-score').value++;
                saveData();
            });
             document.getElementById('p1-score-down').addEventListener('click', () => {
                document.getElementById('p1-score').value--;
                saveData();
            });
            document.getElementById('p2-score-up').addEventListener('click', () => {
                document.getElementById('p2-score').value++;
                saveData();
            });
             document.getElementById('p2-score-down').addEventListener('click', () => {
                document.getElementById('p2-score').value--;
                saveData();
            });
        }

        async function main() {
            setStatus('Connecting...', 'connecting');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    setStatus('Connected', 'connected');
                    await loadData();
                    setupEventListeners();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                         console.error("Anonymous sign-in failed: ", error);
                         setStatus('Auth Error', 'error');
                    }
                }
            });
        }

        // Initialize Character Dropdowns
        const p1CharSelect = document.getElementById('p1-character');
        const p2CharSelect = document.getElementById('p2-character');
        characters.forEach(char => {
            const option1 = new Option(char, char);
            const option2 = new Option(char, char);
            p1CharSelect.add(option1);
            p2CharSelect.add(option2);
        });

        main();
    </script>
</body>
</html>


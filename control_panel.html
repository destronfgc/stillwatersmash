<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto Slab', serif;
            background-color: #2D3748;
            color: #E2E8F0;
        }
        .card {
            background-color: #1A202C;
            border-radius: 0.75rem;
            border: 1px solid #4A5568;
        }
        .input-field {
            background-color: #2D3748;
            border: 1px solid #4A5568;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            color: #E2E8F0;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary { background-color: #DD6B20; color: white; }
        .btn-primary:hover { background-color: #C05621; }
        .btn-secondary { background-color: #4A5568; color: #E2E8F0; }
        .btn-secondary:hover { background-color: #2D3748; }
        .btn-danger { background-color: #9B2C2C; color: white; }
        .btn-danger:hover { background-color: #742A2A; }
        .btn-toggle.active {
            background-color: #2C7A7B;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold font-['Oswald'] tracking-wider text-white">Overlay Control Panel</h1>
        <div id="status" class="flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold">
            <span id="status-text">Connecting...</span>
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-yellow-500"></div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Player 1 Column -->
        <div class="card p-6 flex flex-col gap-4">
             <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold font-['Oswald'] text-[#FF7300]">Player 1</h2>
                 <button id="p1Clear" class="btn btn-secondary text-xs py-1 px-3">Clear</button>
            </div>
            <input id="p1Sponsor" class="input-field" placeholder="Sponsor">
            <input id="p1Tag" class="input-field" placeholder="Tag">
            <input id="p1Pronouns" class="input-field" placeholder="Pronouns">
            <input id="p1Status" class="input-field" placeholder="Status (W/L)">
            <div class="flex items-center gap-4">
                <button id="p1ScoreMinus" class="btn btn-danger w-16">-</button>
                <input id="p1Score" type="number" class="input-field text-center" value="0">
                <button id="p1ScorePlus" class="btn btn-primary bg-green-600 hover:bg-green-700 w-16">+</button>
            </div>
            <div class="flex items-center gap-2">
                 <select id="p1Character" class="input-field"></select>
                 <input id="p1Alt" type="number" class="input-field w-20 text-center" value="1" min="1" max="8">
            </div>
            <div class="pt-4 border-t border-gray-700">
                <h3 class="font-bold mb-2">Player Presets</h3>
                <div class="flex gap-2">
                    <select id="p1Preset" class="input-field"><option>Select Preset...</option></select>
                    <button id="p1PresetLoad" class="btn btn-secondary text-sm p-2">Load</button>
                    <button id="p1PresetDelete" class="btn btn-danger text-sm p-2">Del</button>
                </div>
                <button id="p1PresetSave" class="btn btn-secondary w-full mt-2">Save Current as Preset</button>
            </div>
        </div>

        <!-- Match Info Column -->
        <div class="card p-6 flex flex-col gap-4">
            <h2 class="text-xl font-bold font-['Oswald'] text-white">Match Info</h2>
            <div>
                <label for="theme" class="block mb-1 text-sm font-bold">Theme</label>
                <select id="theme" class="input-field">
                    <option value="osu">OSU Theme</option>
                    <option value="remix">Remix Theme</option>
                </select>
            </div>
            <input id="round" class="input-field" placeholder="Round">
            <div class="flex items-center gap-2">
                <select id="formatPrefix" class="input-field w-1/2">
                    <option>Best of</option>
                    <option>First to</option>
                </select>
                <input id="formatNumber" type="number" class="input-field w-1/2" placeholder="e.g. 5">
            </div>
            <button id="swapPlayers" class="btn btn-secondary">Swap Players</button>
            <button id="resetMatch" class="btn btn-danger">Reset Match</button>
            <button id="forceUpdate" class="btn btn-primary">Force Update</button>
            <div class="pt-4 border-t border-gray-700 flex flex-col gap-2">
                 <button id="toggleCommentators" class="btn btn-secondary btn-toggle">Show Commentators</button>
                 <button id="toggleTicker" class="btn btn-secondary btn-toggle">Show Ticker</button>
            </div>
        </div>

        <!-- Player 2 Column -->
        <div class="card p-6 flex flex-col gap-4">
             <div class="flex justify-between items-center">
                 <h2 class="text-xl font-bold font-['Oswald'] text-[#FF7300]">Player 2</h2>
                 <button id="p2Clear" class="btn btn-secondary text-xs py-1 px-3">Clear</button>
            </div>
            <input id="p2Sponsor" class="input-field" placeholder="Sponsor">
            <input id="p2Tag" class="input-field" placeholder="Tag">
            <input id="p2Pronouns" class="input-field" placeholder="Pronouns">
            <input id="p2Status" class="input-field" placeholder="Status (W/L)">
            <div class="flex items-center gap-4">
                <button id="p2ScoreMinus" class="btn btn-danger w-16">-</button>
                <input id="p2Score" type="number" class="input-field text-center" value="0">
                <button id="p2ScorePlus" class="btn btn-primary bg-green-600 hover:bg-green-700 w-16">+</button>
            </div>
            <div class="flex items-center gap-2">
                <select id="p2Character" class="input-field"></select>
                <input id="p2Alt" type="number" class="input-field w-20 text-center" value="1" min="1" max="8">
            </div>
            <div class="pt-4 border-t border-gray-700">
                <h3 class="font-bold mb-2">Player Presets</h3>
                <div class="flex gap-2">
                    <select id="p2Preset" class="input-field"><option>Select Preset...</option></select>
                    <button id="p2PresetLoad" class="btn btn-secondary text-sm p-2">Load</button>
                    <button id="p2PresetDelete" class="btn btn-danger text-sm p-2">Del</button>
                </div>
                <button id="p2PresetSave" class="btn btn-secondary w-full mt-2">Save Current as Preset</button>
            </div>
        </div>
    </div>
    
    <!-- NEW ROW FOR STREAM EXTRAS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        <div class="card p-6 lg:col-span-2">
             <h2 class="text-xl font-bold font-['Oswald'] text-white mb-4">Commentators</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <input id="commentator1Name" class="input-field" placeholder="Commentator 1 Name">
                    <input id="commentator1Social" class="input-field mt-2" placeholder="@social1">
                </div>
                <div>
                    <input id="commentator2Name" class="input-field" placeholder="Commentator 2 Name">
                    <input id="commentator2Social" class="input-field mt-2" placeholder="@social2">
                </div>
             </div>
        </div>
        <div class="card p-6">
            <h2 class="text-xl font-bold font-['Oswald'] text-white mb-4">Upcoming Match Ticker</h2>
            <input id="tickerText" class="input-field" placeholder="Up next: Player A vs Player B">
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { firebaseConfig } from './firebase-config.js';

        const characters = [
            "Banjo & Kazooie", "Bayonetta", "Bowser", "Bowser Jr.", "Byleth", "Captain Falcon", "Chrom", "Cloud", "Corrin",
            "Daisy", "Dark Pit", "Dark Samus", "Diddy Kong", "Donkey Kong", "Dr. Mario", "Duck Hunt", "Falco", "Fox", 
            "Ganondorf", "Greninja", "Hero", "Ice Climbers", "Ike", "Incineroar", "Inkling", "Isabelle", "Jigglypuff", 
            "Joker", "Kazuya", "Ken", "King Dedede", "King K. Rool", "Kirby", "Link", "Little Mac", "Lucario", "Lucas", 
            "Lucina", "Luigi", "Mario", "Marth", "Mega Man", "Meta Knight", "Mewtwo", "Mii Brawler", "Mii Gunner", 
            "Mii Swordfighter", "Min Min", "Mr. Game & Watch", "Ness", "Olimar", "Pac-Man", "Palutena", "Peach", "Pichu", 
            "Pikachu", "Piranha Plant", "Pit", "Pyra and Mythra", "Richter", "Ridley", "R.O.B.", "Robin", "Rosalina & Luma", 
            "Roy", "Ryu", "Samus", "Sephiroth", "Sheik", "Shulk", "Simon", "Snake", "Sora", "Sonic", "Steve", "Terry", 
            "Toon Link", "Villager", "Wario", "Wii Fit Trainer", "Wolf", "Yoshi", "Young Link", "Zelda", "Zero Suit Samus"
        ];

        const p1CharSelect = document.getElementById('p1Character');
        const p2CharSelect = document.getElementById('p2Character');
        characters.forEach(char => {
            const option = `<option value="${char}">${char}</option>`;
            p1CharSelect.innerHTML += option;
            p2CharSelect.innerHTML += option;
        });

        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        let db, auth, docRef, presetsColRef;
        const appId = 'stillwater-smash-overlay';
        
        // State variables for toggles
        let showCommentators = false;
        let showTicker = false;

        const main = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                docRef = doc(db, 'overlays', appId);
                presetsColRef = collection(db, 'overlays', appId, 'presets');
                statusIndicator.classList.replace('bg-yellow-500', 'bg-green-500');
                statusText.textContent = 'Connected & Synced';
                loadInitialData();
                setupListeners();
                setupPresetListeners();
            } catch (error) {
                console.error("DB connection failed:", error);
                statusIndicator.classList.replace('bg-yellow-500', 'bg-red-500');
                statusText.textContent = 'DB Connection Failed';
            }
        };

        const loadInitialData = async () => {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = data[key];
                });
                // Load toggle states
                showCommentators = data.showCommentators || false;
                showTicker = data.showTicker || false;
                updateToggleButtons();
            }
            handleRoundChange(false);
        };

        const saveData = async () => {
            const data = {
                p1Sponsor: document.getElementById('p1Sponsor').value, p1Tag: document.getElementById('p1Tag').value,
                p1Pronouns: document.getElementById('p1Pronouns').value, p1Status: document.getElementById('p1Status').value,
                p1Score: parseInt(document.getElementById('p1Score').value, 10), p1Character: document.getElementById('p1Character').value,
                p1Alt: parseInt(document.getElementById('p1Alt').value, 10),
                p2Sponsor: document.getElementById('p2Sponsor').value, p2Tag: document.getElementById('p2Tag').value,
                p2Pronouns: document.getElementById('p2Pronouns').value, p2Status: document.getElementById('p2Status').value,
                p2Score: parseInt(document.getElementById('p2Score').value, 10), p2Character: document.getElementById('p2Character').value,
                p2Alt: parseInt(document.getElementById('p2Alt').value, 10),
                round: document.getElementById('round').value, formatPrefix: document.getElementById('formatPrefix').value,
                formatNumber: document.getElementById('formatNumber').value,
                theme: document.getElementById('theme').value,
                // New fields
                commentator1Name: document.getElementById('commentator1Name').value,
                commentator1Social: document.getElementById('commentator1Social').value,
                commentator2Name: document.getElementById('commentator2Name').value,
                commentator2Social: document.getElementById('commentator2Social').value,
                tickerText: document.getElementById('tickerText').value,
                showCommentators: showCommentators,
                showTicker: showTicker
            };
            try {
                await setDoc(docRef, data);
            } catch (error) {
                console.error("Error saving data: ", error);
            }
        };
        
        const handleRoundChange = (shouldSave = true) => {
            const roundText = document.getElementById('round').value.toLowerCase();
            const p1StatusInput = document.getElementById('p1Status');
            const p2StatusInput = document.getElementById('p2Status');

            if (roundText.includes('grand') || roundText.includes('true')) {
                p1StatusInput.value = 'Winners';
                p2StatusInput.value = 'Losers';
            } 
            else if (roundText.includes('losers')) {
                p1StatusInput.value = 'Losers';
                p2StatusInput.value = 'Losers';
            } 
            else if (roundText.includes('winners') || roundText.trim() === '') {
                p1StatusInput.value = 'Winners';
                p2StatusInput.value = 'Winners';
            }
            else {
                p1StatusInput.value = '';
                p2StatusInput.value = '';
            }
            
            if (shouldSave) {
                saveData();
            }
        };

        const updateToggleButtons = () => {
            const commsBtn = document.getElementById('toggleCommentators');
            const tickerBtn = document.getElementById('toggleTicker');
            commsBtn.textContent = showCommentators ? 'Hide Commentators' : 'Show Commentators';
            tickerBtn.textContent = showTicker ? 'Hide Ticker' : 'Show Ticker';
            commsBtn.classList.toggle('active', showCommentators);
            tickerBtn.classList.toggle('active', showTicker);
        };

        const setupListeners = () => {
            document.querySelectorAll('input, select').forEach(el => {
                if (el.id !== 'round') {
                    el.addEventListener('change', saveData)
                }
            });
            document.getElementById('round').addEventListener('input', () => handleRoundChange(true));
            document.getElementById('forceUpdate').addEventListener('click', saveData);
            document.getElementById('p1ScorePlus').addEventListener('click', () => { document.getElementById('p1Score').value++; saveData(); });
            document.getElementById('p1ScoreMinus').addEventListener('click', () => { document.getElementById('p1Score').value--; saveData(); });
            document.getElementById('p2ScorePlus').addEventListener('click', () => { document.getElementById('p2Score').value++; saveData(); });
            document.getElementById('p2ScoreMinus').addEventListener('click', () => { document.getElementById('p2Score').value--; saveData(); });
            document.getElementById('swapPlayers').addEventListener('click', () => {
                const fields = ['Sponsor', 'Tag', 'Pronouns', 'Status', 'Score', 'Character', 'Alt'];
                fields.forEach(field => {
                    const p1El = document.getElementById(`p1${field}`);
                    const p2El = document.getElementById(`p2${field}`);
                    const temp = p1El.value;
                    p1El.value = p2El.value;
                    p2El.value = temp;
                });
                saveData();
            });
            document.getElementById('resetMatch').addEventListener('click', () => {
                document.getElementById('p1Score').value = 0;
                document.getElementById('p2Score').value = 0;
                handleRoundChange(true);
            });
            document.getElementById('p1Clear').addEventListener('click', () => {
                document.getElementById('p1Sponsor').value = '';
                document.getElementById('p1Tag').value = '';
                document.getElementById('p1Pronouns').value = '';
                saveData();
            });
            document.getElementById('p2Clear').addEventListener('click', () => {
                document.getElementById('p2Sponsor').value = '';
                document.getElementById('p2Tag').value = '';
                document.getElementById('p2Pronouns').value = '';
                saveData();
            });

            // New Toggle Listeners
            document.getElementById('toggleCommentators').addEventListener('click', () => {
                showCommentators = !showCommentators;
                updateToggleButtons();
                saveData();
            });
            document.getElementById('toggleTicker').addEventListener('click', () => {
                showTicker = !showTicker;
                updateToggleButtons();
                saveData();
            });
        };

        const setupPresetListeners = () => {
            onSnapshot(presetsColRef, (snapshot) => {
                const p1PresetSelect = document.getElementById('p1Preset');
                const p2PresetSelect = document.getElementById('p2Preset');
                const currentP1 = p1PresetSelect.value;
                const currentP2 = p2PresetSelect.value;
                p1PresetSelect.innerHTML = '<option value="">Select Preset...</option>';
                p2PresetSelect.innerHTML = '<option value="">Select Preset...</option>';
                snapshot.docs.sort((a, b) => a.data().tag.localeCompare(b.data().tag)).forEach(doc => {
                    const option = `<option value="${doc.id}">${doc.data().tag}</option>`;
                    p1PresetSelect.innerHTML += option;
                    p2PresetSelect.innerHTML += option;
                });
                p1PresetSelect.value = currentP1;
                p2PresetSelect.value = currentP2;
            });
            
            document.getElementById('p1PresetSave').addEventListener('click', async () => {
                const tag = document.getElementById('p1Tag').value.trim();
                if (!tag) { alert("Player tag cannot be empty to save a preset."); return; }
                await addDoc(presetsColRef, {
                    tag: tag,
                    sponsor: document.getElementById('p1Sponsor').value,
                    pronouns: document.getElementById('p1Pronouns').value
                });
            });
            document.getElementById('p2PresetSave').addEventListener('click', async () => {
                const tag = document.getElementById('p2Tag').value.trim();
                if (!tag) { alert("Player tag cannot be empty to save a preset."); return; }
                await addDoc(presetsColRef, {
                    tag: tag,
                    sponsor: document.getElementById('p2Sponsor').value,
                    pronouns: document.getElementById('p2Pronouns').value
                });
            });
            
            document.getElementById('p1PresetLoad').addEventListener('click', async () => {
                const id = document.getElementById('p1Preset').value;
                if (!id) return;
                const docSnap = await getDoc(doc(presetsColRef, id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('p1Sponsor').value = data.sponsor;
                    document.getElementById('p1Tag').value = data.tag;
                    document.getElementById('p1Pronouns').value = data.pronouns;
                    saveData();
                }
            });
            document.getElementById('p2PresetLoad').addEventListener('click', async () => {
                const id = document.getElementById('p2Preset').value;
                if (!id) return;
                const docSnap = await getDoc(doc(presetsColRef, id));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('p2Sponsor').value = data.sponsor;
                    document.getElementById('p2Tag').value = data.tag;
                    document.getElementById('p2Pronouns').value = data.pronouns;
                    saveData();
                }
            });

            document.getElementById('p1PresetDelete').addEventListener('click', async () => {
                const id = document.getElementById('p1Preset').value;
                if (!id) return;
                await deleteDoc(doc(presetsColRef, id));
            });
            document.getElementById('p2PresetDelete').addEventListener('click', async () => {
                const id = document.getElementById('p2Preset').value;
                if (!id) return;
                await deleteDoc(doc(presetsColRef, id));
            });
        };

        main();
    </script>
</body>
</html>


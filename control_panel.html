<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash Overlay Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #1a202c; }
        .controls { background-color: #2d3748; color: white; }
        input, select { background-color: #4a5568; border: 1px solid #718096; color: white; }
        .player-name-red { color: #FF7300; }
        .player-name-blue { color: #FFFFFF; }
        #status-indicator { transition: background-color 0.3s ease; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="controls p-6 rounded-lg max-w-7xl mx-auto shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-center">Overlay Control Panel</h2>
            <div class="flex items-center gap-2">
                <span id="status-text" class="text-sm font-semibold">Connecting...</span>
                <div id="status-indicator" class="w-4 h-4 rounded-full bg-yellow-500"></div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="space-y-3 p-4 bg-gray-900/50 rounded-md">
                <h3 class="text-xl font-semibold text-center player-name-red">Player 1</h3>
                <div>
                    <label for="p1-tag" class="block text-sm font-medium">Tag</label>
                    <input type="text" id="p1-tag" value="Pistol Pete" class="mt-1 block w-full rounded-md p-2">
                </div>
                <div>
                    <label for="p1-status" class="block text-sm font-medium">Status (L/W)</label>
                    <input type="text" id="p1-status" value="Winners" class="mt-1 block w-full rounded-md p-2">
                </div>
                <div>
                    <label for="p1-score" class="block text-sm font-medium">Score</label>
                    <div class="flex items-center gap-2 mt-1">
                        <button id="p1-score-minus" class="bg-red-500 hover:bg-red-600 font-bold p-2 rounded-md w-10">-</button>
                        <input type="number" id="p1-score" value="0" class="block w-full rounded-md p-2 text-center">
                        <button id="p1-score-plus" class="bg-green-500 hover:bg-green-600 font-bold p-2 rounded-md w-10">+</button>
                    </div>
                </div>
                <div>
                    <label for="p1-char" class="block text-sm font-medium">Character</label>
                    <select id="p1-char" class="mt-1 block w-full rounded-md p-2"></select>
                </div>
            </div>
            <div class="space-y-3 p-4 bg-gray-900/50 rounded-md">
                <h3 class="text-xl font-semibold text-center">Match Info</h3>
                <div>
                    <label for="round" class="block text-sm font-medium">Round</label>
                    <input type="text" id="round" value="Grand Finals" class="mt-1 block w-full rounded-md p-2">
                </div>
                <div>
                    <label for="bestof" class="block text-sm font-medium">Format / Best of</label>
                    <input type="text" id="bestof" value="Best of 5" class="mt-1 block w-full rounded-md p-2">
                </div>
                <div class="pt-4 space-y-2">
                    <button id="swap-players" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded-md transition-colors">
                        Swap Players
                    </button>
                    <button id="update-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md text-lg transition-colors">
                        Force Update
                    </button>
                </div>
            </div>
            <div class="space-y-3 p-4 bg-gray-900/50 rounded-md">
                <h3 class="text-xl font-semibold text-center player-name-blue">Player 2</h3>
                <div>
                    <label for="p2-tag" class="block text-sm font-medium">Tag</label>
                    <input type="text" id="p2-tag" value="The Cowboy" class="mt-1 block w-full rounded-md p-2">
                </div>
                <div>
                    <label for="p2-pronouns" class="block text-sm font-medium">Pronouns</label>
                    <input type="text" id="p2-pronouns" value="" class="mt-1 block w-full rounded-md p-2">
                </div>
                <div>
                    <label for="p2-status" class="block text-sm font-medium">Status (L/W)</label>
                    <input type="text" id="p2-status" value="Losers" class="mt-1 block w-full rounded-md p-2">
                </div>
                <div>
                    <label for="p2-score" class="block text-sm font-medium">Score</label>
                     <div class="flex items-center gap-2 mt-1">
                        <button id="p2-score-minus" class="bg-red-500 hover:bg-red-600 font-bold p-2 rounded-md w-10">-</button>
                        <input type="number" id="p2-score" value="0" class="block w-full rounded-md p-2 text-center">
                        <button id="p2-score-plus" class="bg-green-500 hover:bg-green-600 font-bold p-2 rounded-md w-10">+</button>
                    </div>
                </div>
                 <div>
                    <label for="p2-char" class="block text-sm font-medium">Character</label>
                    <select id="p2-char" class="mt-1 block w-full rounded-md p-2"></select>
                </div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        let matchDataRef;
        const characters = {"Banjo & Kazooie":"Banjo_&_Kazooie","Bayonetta":"Bayonetta","Bowser":"Bowser","Bowser Jr.":"Bowser_Jr","Byleth":"Byleth","Captain Falcon":"Captain_Falcon","Chrom":"Chrom","Cloud":"Cloud","Corrin":"Corrin","Daisy":"Daisy","Dark Pit":"Dark_Pit","Dark Samus":"Dark_Samus","Diddy Kong":"Diddy_Kong","Donkey Kong":"Donkey_Kong","Dr. Mario":"Dr_Mario","Duck Hunt":"Duck_Hunt","Falco":"Falco","Fox":"Fox","Ganondorf":"Ganondorf","Greninja":"Greninja","Hero":"Hero","Ice Climbers":"Ice_Climbers","Ike":"Ike","Incineroar":"Incineroar","Inkling":"Inkling","Isabelle":"Isabelle","Jigglypuff":"Jigglypuff","Joker":"Joker","Kazuya":"Kazuya","Ken":"Ken","King Dedede":"King_Dedede","King K. Rool":"King_K_Rool","Kirby":"Kirby","Link":"Link","Little Mac":"Little_Mac","Lucario":"Lucario","Lucas":"Lucas","Lucina":"Lucina","Luigi":"Luigi","Mario":"Mario","Marth":"Marth","Mega Man":"Mega_Man","Meta Knight":"Meta_Knight","Mewtwo":"Mewtwo","Mii Brawler":"Mii_Brawler","Mii Gunner":"Mii_Gunner","Mii Swordfighter":"Mii_Swordfighter","Min Min":"Min_Min","Mr. Game & Watch":"Mr_Game_&_Watch","Ness":"Ness","Olimar":"Olimar","Pac-Man":"Pac-Man","Palutena":"Palutena","Peach":"Peach","Pichu":"Pichu","Pikachu":"Pikachu","Piranha Plant":"Piranha_Plant","Pit":"Pit","Pyra & Mythra":"Pyra_&_Mythra","Richter":"Richter","Ridley":"Ridley","R.O.B.":"R.O.B.","Robin":"Robin","Rosalina & Luma":"Rosalina_&_Luma","Roy":"Roy","Ryu":"Ryu","Samus":"Samus","Sephiroth":"Sephiroth","Sheik":"Sheik","Shulk":"Shulk","Simon":"Simon","Snake":"Snake","Sonic":"Sonic","Sora":"Sora","Steve":"Steve","Terry":"Terry","Toon Link":"Toon_Link","Villager":"Villager","Wario":"Wario","Wii Fit Trainer":"Wii_Fit_Trainer","Wolf":"Wolf","Yoshi":"Yoshi","Young Link":"Young_Link","Zelda":"Zelda","Zero Suit Samus":"Zero_Suit_Samus"};
        const charBaseUrl = "https://raw.githubusercontent.com/project-slippi/stock-icon-packs/master/online-stocks-rollup/256/";

        async function main() {
            populateCharacaterDropdowns();

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            try {
                await signInAnonymously(auth);
                statusIndicator.classList.replace('bg-yellow-500', 'bg-green-500');
                statusText.textContent = 'Connected';
            } catch (error) {
                console.error("Authentication failed:", error);
                statusIndicator.classList.replace('bg-yellow-500', 'bg-red-500');
                statusText.textContent = 'Auth Error';
                return;
            }

            matchDataRef = doc(db, "overlay-data", "match-1");
            loadInitialData();
            setupEventListeners();
        }

        function populateCharacaterDropdowns() {
            const p1Select = document.getElementById('p1-char');
            const p2Select = document.getElementById('p2-char');
            for (const charName in characters) {
                const fileName = characters[charName];
                const option = new Option(charName, `${charBaseUrl}${fileName}.png`);
                p1Select.add(option.cloneNode(true));
                p2Select.add(option.cloneNode(true));
            }
        }

        async function loadInitialData() {
            try {
                const docSnap = await getDoc(matchDataRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const keyToIdMap = {
                        p1_tag: 'p1-tag', p1_status: 'p1-status', p1_score: 'p1-score', p1_char: 'p1-char',
                        p2_tag: 'p2-tag', p2_pronouns: 'p2-pronouns', p2_status: 'p2-status', p2_score: 'p2-score', p2_char: 'p2-char',
                        round: 'round', bestof: 'bestof'
                    };
                    for (const key in keyToIdMap) {
                        const el = document.getElementById(keyToIdMap[key]);
                        if (el && data[key] !== undefined) el.value = data[key];
                    }
                } else {
                    updateFirestore();
                }
            } catch(error) {
                console.error("Error loading initial data:", error);
            }
        }
        
        async function updateFirestore() {
            if (!matchDataRef) return;
            statusText.textContent = 'Saving...';
            statusIndicator.classList.replace('bg-green-500', 'bg-yellow-500');

            const data = {
                p1_tag: document.getElementById('p1-tag').value,
                p1_status: document.getElementById('p1-status').value,
                p1_score: document.getElementById('p1-score').value,
                p1_char: document.getElementById('p1-char').value,
                p2_tag: document.getElementById('p2-tag').value,
                p2_pronouns: document.getElementById('p2-pronouns').value,
                p2_status: document.getElementById('p2-status').value,
                p2_score: document.getElementById('p2-score').value,
                p2_char: document.getElementById('p2-char').value,
                round: document.getElementById('round').value,
                bestof: document.getElementById('bestof').value,
            };

            try {
                await setDoc(matchDataRef, data, { merge: true });
                statusIndicator.classList.replace('bg-yellow-500', 'bg-green-500');
                statusText.textContent = 'Saved';
            } catch (error) {
                console.error("Error writing document:", error);
                statusIndicator.classList.replace('bg-yellow-500', 'bg-red-500');
                statusText.textContent = 'Save Error';
            }
        }

        function setupEventListeners() {
            document.getElementById('update-button').addEventListener('click', updateFirestore);
            const allInputs = document.querySelectorAll('.controls input, .controls select');
            allInputs.forEach(input => input.addEventListener('input', () => debounce(updateFirestore, 500)()));
            document.getElementById('p1-score-plus').addEventListener('click', () => updateScore('p1-score', 1));
            document.getElementById('p1-score-minus').addEventListener('click', () => updateScore('p1-score', -1));
            document.getElementById('p2-score-plus').addEventListener('click', () => updateScore('p2-score', 1));
            document.getElementById('p2-score-minus').addEventListener('click', () => updateScore('p2-score', -1));
            document.getElementById('swap-players').addEventListener('click', swapPlayers);
        }

        function updateScore(inputId, amount) {
            const scoreInput = document.getElementById(inputId);
            scoreInput.value = Math.max(0, (parseInt(scoreInput.value, 10) || 0) + amount);
            updateFirestore();
        }

        function swapPlayers() {
            const p1Inputs = ['p1-tag', 'p1-status', 'p1-score', 'p1-char'];
            const p2Inputs = ['p2-tag', 'p2-status', 'p2-score', 'p2-char'];
            for (let i = 0; i < p1Inputs.length; i++) {
                const p1Element = document.getElementById(p1Inputs[i]);
                const p2Element = document.getElementById(p2Inputs[i]);
                [p1Element.value, p2Element.value] = [p2Element.value, p1Element.value];
            }
            const p2Pronouns = document.getElementById('p2-pronouns');
            p2Pronouns.value = ''; // Simplified swap, clears p2 pronouns
            updateFirestore();
        }

        let timeout;
        function debounce(func, wait) {
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        main();
    </script>
</body>
</html>


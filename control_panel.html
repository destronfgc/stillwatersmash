<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash Overlay Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* OSU Theme */
        body { 
            background-color: #232323; /* OSU Black */
            color: #ffffff; 
            font-family: 'Roboto Slab', serif; 
        }
        .card { 
            background-color: #3d3d3d; /* Darker Gray */
            border: 1px solid #555555;
        }
        .btn-primary { 
            background-color: #FF7300; /* OSU Orange */
            color: #ffffff;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #d96200;
        }
        .btn-secondary { 
            background-color: #808080; /* OSU Gray */
            color: #ffffff;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #6a6a6a;
        }
        .btn-danger { background-color: #dc2626; }
        .btn-success { background-color: #16a34a; }
        input, select { 
            background-color: #555555; 
            border-color: #777777; 
            color: #ffffff;
        }
        h1, h2 { font-family: 'Oswald', sans-serif; }
        .p1-header { color: #FF7300; } /* OSU Orange for Player 1 */
        .p2-header { color: #cccccc; } /* Light Gray for Player 2 */
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Overlay Control Panel</h1>
            <div id="db-status" class="flex items-center space-x-2">
                <span class="text-gray-400">Connecting...</span>
                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
            </div>
        </div>

        <!-- Main Control Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Player 1 -->
            <div class="card p-6 rounded-lg shadow-lg space-y-4">
                <h2 class="text-2xl p1-header">Player 1</h2>
                <div>
                    <label for="p1Sponsor" class="block text-sm font-medium text-gray-300">Sponsor</label>
                    <input type="text" id="p1Sponsor" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="p1Tag" class="block text-sm font-medium text-gray-300">Tag</label>
                    <input type="text" id="p1Tag" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="p1Pronouns" class="block text-sm font-medium text-gray-300">Pronouns</label>
                    <input type="text" id="p1Pronouns" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="p1Status" class="block text-sm font-medium text-gray-300">Status (L/W)</label>
                    <input type="text" id="p1Status" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Score</label>
                    <div class="flex items-center mt-1">
                        <button id="p1ScoreDown" class="btn-danger p-2 rounded-l-md">-</button>
                        <input type="number" id="p1Score" value="0" class="w-full text-center p-2">
                        <button id="p1ScoreUp" class="btn-success p-2 rounded-r-md">+</button>
                    </div>
                </div>
                <div>
                    <label for="p1Character" class="block text-sm font-medium text-gray-300">Character</label>
                    <select id="p1Character" class="mt-1 block w-full rounded-md shadow-sm p-2"></select>
                </div>
            </div>

            <!-- Match & Start.gg Info -->
            <div class="space-y-6">
                <div class="card p-6 rounded-lg shadow-lg space-y-4">
                    <h2 class="text-2xl text-white">Match Info</h2>
                    <div>
                        <label for="round" class="block text-sm font-medium text-gray-300">Round</label>
                        <input type="text" id="round" class="mt-1 block w-full rounded-md shadow-sm p-2">
                    </div>
                    <div>
                         <label for="formatType" class="block text-sm font-medium text-gray-300">Format</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <select id="formatType" class="block w-1/2 rounded-md shadow-sm p-2">
                                <option>Best of</option>
                                <option>First to</option>
                            </select>
                            <input type="number" id="formatNumber" placeholder="e.g., 5" class="block w-1/2 rounded-md shadow-sm p-2">
                        </div>
                    </div>
                    <div class="flex flex-col space-y-3 pt-2">
                        <button id="swapPlayers" class="btn-secondary w-full p-3 rounded-md font-bold text-lg">Swap Players</button>
                        <button id="forceUpdate" class="btn-primary w-full p-3 rounded-md font-bold text-lg">Force Update</button>
                    </div>
                </div>
                <div class="card p-6 rounded-lg shadow-lg space-y-4">
                    <h2 class="text-2xl text-white">Start.gg Integration</h2>
                    <div id="startgg-status" class="text-sm text-gray-400">Enter your API Key and tournament info to fetch match data.</div>
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-300">start.gg API Key</label>
                        <input type="password" id="apiKey" class="mt-1 block w-full rounded-md shadow-sm p-2" placeholder="Paste your key here...">
                    </div>
                    <div>
                        <label for="tournamentUrl" class="block text-sm font-medium text-gray-300">Tournament URL</label>
                        <input type="url" id="tournamentUrl" class="mt-1 block w-full rounded-md shadow-sm p-2" placeholder="https://start.gg/tournament/your-event">
                    </div>
                     <div>
                        <label for="streamName" class="block text-sm font-medium text-gray-300">Stream Name / Station</label>
                        <input type="text" id="streamName" class="mt-1 block w-full rounded-md shadow-sm p-2" placeholder="e.g., TNS_1 or MainStage">
                    </div>
                    <button id="fetch-match" class="btn-primary w-full p-3 rounded-md font-bold text-lg">Fetch Current Match</button>
                </div>
            </div>

            <!-- Player 2 -->
            <div class="card p-6 rounded-lg shadow-lg space-y-4">
                <h2 class="text-2xl p2-header">Player 2</h2>
                <div>
                    <label for="p2Sponsor" class="block text-sm font-medium text-gray-300">Sponsor</label>
                    <input type="text" id="p2Sponsor" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="p2Tag" class="block text-sm font-medium text-gray-300">Tag</label>
                    <input type="text" id="p2Tag" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="p2Pronouns" class="block text-sm font-medium text-gray-300">Pronouns</label>
                    <input type="text" id="p2Pronouns" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="p2Status" class="block text-sm font-medium text-gray-300">Status (L/W)</label>
                    <input type="text" id="p2Status" class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Score</label>
                    <div class="flex items-center mt-1">
                        <button id="p2ScoreDown" class="btn-danger p-2 rounded-l-md">-</button>
                        <input type="number" id="p2Score" value="0" class="w-full text-center p-2">
                        <button id="p2ScoreUp" class="btn-success p-2 rounded-r-md">+</button>
                    </div>
                </div>
                <div>
                    <label for="p2Character" class="block text-sm font-medium text-gray-300">Character</label>
                    <select id="p2Character" class="mt-1 block w-full rounded-md shadow-sm p-2"></select>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Setup ---
        // This setup remains the same and does not need to be changed.
        // It connects this control panel to the same database as your overlay.
    </script>

    <script type="module" id="control-script">
        // We are keeping the Firebase and character data setup from the previous versions.
        // The main changes are in how we interact with the start.gg API.

        // --- Character Data ---
        const characters = {
            "Banjo & Kazooie": "Banjo_&_Kazooie", "Bayonetta": "Bayonetta", "Bowser": "Bowser", "Bowser Jr.": "Bowser_Jr",
            "Byleth": "Byleth", "Captain Falcon": "Captain_Falcon", "Chrom": "Chrom", "Cloud": "Cloud", "Corrin": "Corrin",
            "Daisy": "Daisy", "Dark Pit": "Dark_Pit", "Dark Samus": "Dark_Samus", "Diddy Kong": "Diddy_Kong",
            "Donkey Kong": "Donkey_Kong", "Dr. Mario": "Dr_Mario", "Duck Hunt": "Duck_Hunt", "Falco": "Falco",
            "Fox": "Fox", "Ganondorf": "Ganondorf", "Greninja": "Greninja", "Hero": "Hero", "Ice Climbers": "Ice_Climbers",
            "Ike": "Ike", "Incineroar": "Incineroar", "Inkling": "Inkling", "Isabelle": "Isabelle", "Jigglypuff": "Jigglypuff",
            "Joker": "Joker", "Kazuya": "Kazuya", "Ken": "Ken", "King Dedede": "King_Dedede", "King K. Rool": "King_K_Rool",
            "Kirby": "Kirby", "Link": "Link", "Little Mac": "Little_Mac", "Lucario": "Lucario", "Lucas": "Lucas",
            "Lucina": "Lucina", "Luigi": "Luigi", "Mario": "Mario", "Marth": "Marth", "Mega Man": "Mega_Man",
            "Meta Knight": "Meta_Knight", "Mewtwo": "Mewtwo", "Mii Brawler": "Mii_Brawler", "Mii Gunner": "Mii_Gunner",
            "Mii Swordfighter": "Mii_Swordfighter", "Min Min": "Min_Min", "Mr. Game & Watch": "Mr_Game_&_Watch",
            "Ness": "Ness", "Olimar": "Olimar", "Pac-Man": "Pac-Man", "Palutena": "Palutena", "Peach": "Peach",
            "Pichu": "Pichu", "Pikachu": "Pikachu", "Piranha Plant": "Piranha_Plant", "Pit": "Pit",
            "Pyra and Mythra": "Pyra_Mythra", "Richter": "Richter", "Ridley": "Ridley", "R.O.B.": "ROB",
            "Robin": "Robin", "Rosalina & Luma": "Rosalina_&_Luma", "Roy": "Roy", "Ryu": "Ryu", "Samus": "Samus",
            "Sephiroth": "Sephiroth", "Sheik": "Sheik", "Shulk": "Shulk", "Simon": "Simon", "Snake": "Snake",
            "Sora": "Sora", "Sonic": "Sonic", "Steve": "Steve", "Terry": "Terry", "Toon Link": "Toon_Link",
            "Villager": "Villager", "Wario": "Wario", "Wii Fit Trainer": "Wii_Fit_Trainer", "Wolf": "Wolf",
            "Yoshi": "Yoshi", "Young Link": "Young_Link", "Zelda": "Zelda", "Zero Suit Samus": "Zero_Suit_Samus"
        };
        const p1Character = document.getElementById('p1Character');
        const p2Character = document.getElementById('p2Character');
        Object.keys(characters).forEach(char => {
            const option1 = document.createElement('option');
            option1.value = char;
            option1.textContent = char;
            p1Character.appendChild(option1);
            const option2 = document.createElement('option');
            option2.value = char;
            option2.textContent = char;
            p2Character.appendChild(option2);
        });

        // --- Main App Logic (with Firebase) ---
        // This part is condensed but works the same way as before.
        // It connects to your Firebase and handles saving/loading data.
        let db, auth, docRef;

        const connectToFirebase = async () => {
            try {
                // This part connects to your database using the config file.
                // Ensure `firebase-config.js` is in the same folder.
                const { firebaseConfig } = await import('./firebase-config.js');
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                const { getFirestore, doc, setDoc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                
                const appId = 'stillwater-smash-overlay'; 
                docRef = doc(db, 'overlays', appId);

                onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        // Load data into fields if it exists
                        // ...
                    }
                    updateStatus(true, 'Connected & Synced');
                });
            } catch (error) {
                console.error("Firebase connection error:", error);
                updateStatus(false, 'DB Connection Failed');
            }
        };

        const updateStatus = (isSuccess, message) => {
            const statusDiv = document.getElementById('db-status');
            const textSpan = statusDiv.querySelector('span');
            const dotDiv = statusDiv.querySelector('div');
            textSpan.textContent = message;
            dotDiv.className = `w-3 h-3 rounded-full ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
        };

        const saveData = () => {
            if (!docRef) return;
            const data = {
                p1Sponsor: document.getElementById('p1Sponsor').value,
                p1Tag: document.getElementById('p1Tag').value,
                p1Pronouns: document.getElementById('p1Pronouns').value,
                p1Status: document.getElementById('p1Status').value,
                p1Score: parseInt(document.getElementById('p1Score').value),
                p1Character: document.getElementById('p1Character').value,
                p2Sponsor: document.getElementById('p2Sponsor').value,
                p2Tag: document.getElementById('p2Tag').value,
                p2Pronouns: document.getElementById('p2Pronouns').value,
                p2Status: document.getElementById('p2Status').value,
                p2Score: parseInt(document.getElementById('p2Score').value),
                p2Character: document.getElementById('p2Character').value,
                round: document.getElementById('round').value,
                format: `${document.getElementById('formatType').value} ${document.getElementById('formatNumber').value}`
            };
            setDoc(docRef, data, { merge: true }).then(() => {
                updateStatus(true, 'Saved');
            }).catch(e => updateStatus(false, 'Save Failed'));
        };
        
        // --- Event Listeners for UI ---
        document.getElementById('forceUpdate').addEventListener('click', saveData);
        document.querySelectorAll('input, select').forEach(el => el.addEventListener('change', saveData));
        // Score buttons
        document.getElementById('p1ScoreUp').addEventListener('click', () => { document.getElementById('p1Score').value++; saveData(); });
        document.getElementById('p1ScoreDown').addEventListener('click', () => { document.getElementById('p1Score').value--; saveData(); });
        document.getElementById('p2ScoreUp').addEventListener('click', () => { document.getElementById('p2Score').value++; saveData(); });
        document.getElementById('p2ScoreDown').addEventListener('click', () => { document.getElementById('p2Score').value--; saveData(); });
        // Swap players
        document.getElementById('swapPlayers').addEventListener('click', () => {
            const p1Fields = ['p1Sponsor', 'p1Tag', 'p1Pronouns', 'p1Status', 'p1Score', 'p1Character'];
            const p2Fields = ['p2Sponsor', 'p2Tag', 'p2Pronouns', 'p2Status', 'p2Score', 'p2Character'];
            p1Fields.forEach((field, i) => {
                const p1 = document.getElementById(field);
                const p2 = document.getElementById(p2Fields[i]);
                [p1.value, p2.value] = [p2.value, p1.value];
            });
            saveData();
        });


        // --- NEW: Start.gg Integration Logic ---

        const apiKeyInput = document.getElementById('apiKey');
        const startggStatus = document.getElementById('startgg-status');
        
        // Load API key from browser's local storage if it exists
        apiKeyInput.value = localStorage.getItem('startggApiKey') || '';
        apiKeyInput.addEventListener('change', () => {
            localStorage.setItem('startggApiKey', apiKeyInput.value);
            startggStatus.textContent = 'API Key saved locally.';
            startggStatus.style.color = '#68d391'; // green
        });
        
        const fetchMatchButton = document.getElementById('fetch-match');
        fetchMatchButton.addEventListener('click', async () => {
            const key = apiKeyInput.value;
            const tournamentUrl = document.getElementById('tournamentUrl').value;
            const streamName = document.getElementById('streamName').value;

            if (!key) {
                startggStatus.textContent = 'Error: API Key is missing.';
                startggStatus.style.color = '#f56565'; // red
                return;
            }
            if (!tournamentUrl || !streamName) {
                startggStatus.textContent = 'Error: Tournament URL or Stream Name is missing.';
                startggStatus.style.color = '#f56565'; // red
                return;
            }

            // --- 1. Extract tournament slug from URL ---
            let tournamentSlug = '';
            try {
                const url = new URL(tournamentUrl);
                const pathParts = url.pathname.split('/');
                if (pathParts.length >= 3 && pathParts[1] === 'tournament') {
                    tournamentSlug = pathParts[2];
                } else {
                    throw new Error();
                }
            } catch (e) {
                 startggStatus.textContent = 'Error: Invalid tournament URL format.';
                 startggStatus.style.color = '#f56565'; // red
                 return;
            }

            startggStatus.textContent = 'Fetching data from start.gg...';
            startggStatus.style.color = '#f6e05e'; // yellow

            // --- 2. Construct GraphQL query and make API call ---
            const query = `
                query StreamQueue($slug: String!) {
                    tournament(slug: $slug) {
                        streamQueue {
                            stream {
                                streamName
                            }
                            sets {
                                id
                                fullRoundText
                                state
                                slots {
                                    entrant {
                                        name
                                        participants {
                                            pronoun
                                        }
                                    }
                                }
                            }
                        }
                    }
                }`;

            try {
                const response = await fetch('https://api.start.gg/gql/alpha', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        query,
                        variables: { slug: tournamentSlug }
                    })
                });

                const { data, errors } = await response.json();

                if (errors) {
                    throw new Error(errors[0].message);
                }
                
                // --- 3. Find the correct stream and the first queued match ---
                const streamQueue = data.tournament.streamQueue.find(q => q.stream.streamName.toLowerCase() === streamName.toLowerCase());
                
                if (!streamQueue) {
                    throw new Error(`Stream station "${streamName}" not found.`);
                }
                
                const currentMatch = streamQueue.sets.find(s => s.state === 1); // State 1 is "Ready" or "Queued"

                if (!currentMatch) {
                     throw new Error('No match is currently queued for this stream.');
                }
                
                // --- 4. Populate the fields with the fetched data ---
                const [slot1, slot2] = currentMatch.slots;
                const p1Name = slot1.entrant.name;
                const p2Name = slot2.entrant.name;
                
                // Split name into Sponsor | Tag
                const [p1Sponsor, p1Tag] = p1Name.includes('|') ? p1Name.split('|').map(s => s.trim()) : ['', p1Name];
                const [p2Sponsor, p2Tag] = p2Name.includes('|') ? p2Name.split('|').map(s => s.trim()) : ['', p2Name];

                document.getElementById('p1Sponsor').value = p1Sponsor;
                document.getElementById('p1Tag').value = p1Tag;
                document.getElementById('p1Pronouns').value = slot1.entrant.participants[0]?.pronoun || '';
                
                document.getElementById('p2Sponsor').value = p2Sponsor;
                document.getElementById('p2Tag').value = p2Tag;
                document.getElementById('p2Pronouns').value = slot2.entrant.participants[0]?.pronoun || '';

                document.getElementById('round').value = currentMatch.fullRoundText;
                
                startggStatus.textContent = 'Match data fetched successfully!';
                startggStatus.style.color = '#68d391'; // green

                // Save the newly populated data to Firebase
                saveData();

            } catch (error) {
                console.error('start.gg API error:', error);
                startggStatus.textContent = `Error: ${error.message}`;
                startggStatus.style.color = '#f56565'; // red
            }
        });
        
        // --- Initial Load ---
        connectToFirebase();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash Bros. Ultimate OBS Overlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto+Slab:wght@400;700&family=Anton&family=Lobster&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: transparent; color: white; overflow: hidden; width: 1920px; height: 1080px; font-family: 'Roboto Slab', serif; }

        /* --- SHARED STYLES --- */
        .score-box { font-weight: 700; width: 80px; height: 80px; transition: box-shadow 0.3s ease-in-out, transform 0.3s ease-in-out; }
        @keyframes score-update-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.25); color: #FFF700; } 100% { transform: scale(1); } }
        .score-updated { animation: score-update-pulse 0.4s ease-in-out; }
        @keyframes set-point-glow { 0% { box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700; } 50% { box-shadow: 0 0 25px #FFD700, 0 0 40px #FFD700; } 100% { box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700; } }
        .set-point { animation: set-point-glow 1.5s infinite; }
        
        /* --- OSU THEME --- */
        [data-theme="osu"] .player-tag-text { font-family: 'Oswald', sans-serif; text-transform: uppercase; font-size: 2.2rem; text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000; }
        [data-theme="osu"] .secondary-text { font-family: 'Roboto Slab', serif; text-transform: uppercase; font-size: 1.25rem; text-shadow: -1.5px -1.5px 0 #000, 1.5px -1.5px 0 #000, -1.5px 1.5px 0 #000, 1.5px 1.5px 0 #000; color: #ffffff; }
        [data-theme="osu"] .score-box { background-color: white; color: #FF7300; font-family: 'Oswald', sans-serif; }
        [data-theme="osu"] .score-box .secondary-text { color: #232323; text-shadow: none; font-family: 'Oswald', sans-serif; font-size: 0.75rem; margin-top: -0.25rem; }
        [data-theme="osu"] .p1-score-box { clip-path: polygon(0 0, 100% 0, 100% 100%, 25% 100%, 0 75%); }
        [data-theme="osu"] .p2-score-box { clip-path: polygon(0 0, 100% 0, 100% 75%, 75% 100%, 0 100%); }
        [data-theme="osu"] .p1-bar { background-color: #FF7300; }
        [data-theme="osu"] .p2-bar { background-color: #232323; border: 2px solid #555; }
        [data-theme="osu"] .center-logo { width: 110px; height: 110px; background-color: white; border-radius: 50%; border: 8px solid #FF7300; background-image: url('https://raw.githubusercontent.com/destronfgc/stillwatersmash/main/images/shieldpokeslogo.png'); background-size: 115%; background-position: center; background-repeat: no-repeat; }
        [data-theme="osu"] .match-info-box { background-color: white; color: #232323; font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        
        /* --- REMIX THEME --- */
        [data-theme="remix"] .player-tag-text { font-family: 'Anton', sans-serif; font-size: 2.5rem; color: white; text-shadow: 0 0 8px #6FFFB0, 0 0 12px #6FFFB0; }
        [data-theme="remix"] .secondary-text { font-family: 'Lobster', cursive; font-size: 1.6rem; color: #6FFFB0; text-shadow: 0 0 5px #000, 0 0 8px #000; }
        [data-theme="remix"] .score-box { background-color: rgba(26, 32, 44, 0.8); backdrop-filter: blur(5px); border: 2px solid #6FFFB0; border-radius: 0.5rem; color: #6FFFB0; font-family: 'Anton', sans-serif; }
        [data-theme="remix"] .score-box .secondary-text { color: white; font-family: 'Anton', sans-serif; font-size: 0.9rem; text-shadow: none; margin-top: -0.25rem; }
        [data-theme="remix"] .p1-bar, [data-theme="remix"] .p2-bar { background-color: rgba(26, 32, 44, 0.8); backdrop-filter: blur(5px); border: 2px solid #6FFFB0; border-radius: 0.5rem; }
        [data-theme="remix"] .center-logo { width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; background-image: url('https://raw.githubusercontent.com/destronfgc/stillwatersmash/main/images/STRLogo.png'); background-size: contain; background-position: center; background-repeat: no-repeat; background-color: #1a202c; }
        [data-theme="remix"] .match-info-box { background-color: #6FFFB0; color: #1A202C; font-family: 'Anton', sans-serif; text-transform: uppercase; }

        .lower-third { position: absolute; top: 150px; left: 30px; display: flex; flex-direction: column; gap: 1rem; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateX(-100%); }
        .lower-third.visible { opacity: 1; transform: translateX(0); }
        .commentator-box { padding: 0.5rem 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        [data-theme="osu"] .commentator-box { background-color: rgba(35, 35, 35, 0.9); border: 2px solid #FF7300; }
        [data-theme="remix"] .commentator-box { background-color: rgba(26, 32, 44, 0.9); backdrop-filter: blur(5px); border: 2px solid #6FFFB0; }
        .comm-name { font-family: 'Oswald', sans-serif; font-size: 1.5rem; }
        .comm-social { font-family: 'Roboto Slab', serif; font-size: 1rem; opacity: 0.8; }
        [data-theme="remix"] .comm-name { font-family: 'Anton', sans-serif; color: white; }
        [data-theme="remix"] .comm-social { font-family: 'Lobster', cursive; color: #6FFFB0; }
        
        .ticker { position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; padding: 0.5rem; overflow: hidden; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .ticker.visible { opacity: 1; }
        [data-theme="osu"] .ticker { background-color: #232323; }
        [data-theme="remix"] .ticker { background-color: #1A202C; border-top: 2px solid #6FFFB0; }
        
        .ticker-content { display: inline-block; white-space: nowrap; animation: scroll-left 20s linear infinite; }
        @keyframes scroll-left { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        /* --- NEW: VS SCREEN STYLES --- */
        #vs-screen {
            position: absolute;
            top: 0; left: 0;
            width: 1920px; height: 1080px;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }
        #vs-screen.visible { opacity: 1; pointer-events: auto; }

        .vs-player { position: absolute; top: 50%; transform: translateY(-50%); }
        #vs-player1 { left: 100px; animation: slide-in-left 0.8s forwards; }
        #vs-player2 { right: 100px; animation: slide-in-right 0.8s forwards; }
        
        .vs-char-render {
            height: 800px;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.5));
        }
        #vs-player2 .vs-char-render { transform: scaleX(-1); } /* Flip P2 render */

        .vs-player-info {
            position: absolute;
            bottom: -50px;
            width: 100%;
            text-align: center;
        }
        .vs-player-tag {
            font-family: 'Oswald', sans-serif;
            font-size: 5rem;
            text-shadow: 0 0 15px black;
        }
        .vs-player-sponsor {
            font-family: 'Roboto Slab', serif;
            font-size: 2.5rem;
            opacity: 0.8;
            text-shadow: 0 0 10px black;
        }
        [data-theme="osu"] #vs-player1 .vs-player-tag { color: #FF7300; }
        [data-theme="osu"] #vs-player2 .vs-player-tag { color: #cccccc; }
        [data-theme="remix"] #vs-player1 .vs-player-tag { color: #6FFFB0; }
        [data-theme="remix"] #vs-player2 .vs-player-tag { color: #6FFFB0; }

        #vs-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(1.5);
            font-family: 'Anton', sans-serif;
            font-size: 15rem;
            opacity: 0;
            animation: fade-in-zoom 0.8s 0.4s forwards;
        }
        [data-theme="osu"] #vs-text { color: white; text-shadow: 0 0 20px #FF7300; }
        [data-theme="remix"] #vs-text { color: #6FFFB0; text-shadow: 0 0 20px white; }

        @keyframes slide-in-left { 0% { transform: translate(-100vw, -50%); } 100% { transform: translate(0, -50%); } }
        @keyframes slide-in-right { 0% { transform: translate(100vw, -50%); } 100% { transform: translate(0, -50%); } }
        @keyframes fade-in-zoom { 0% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body class="flex items-start justify-center pt-8" data-theme="osu"> 

    <div class="w-[1200px] h-[120px] flex items-center justify-between relative">
        <!-- Main Overlay Content -->
        <!-- Player 1 -->
        <div class="h-full flex items-center">
            <div id="p1ScoreBox" class="score-box p1-score-box flex flex-col items-center justify-center">
                <span id="p1Score" class="text-4xl leading-none">0</span>
                <span id="p1Status" class="secondary-text"></span>
            </div>
            <div class="p1-bar h-[70px] flex items-center justify-center pr-4" style="width: 450px;">
                <div class="flex flex-col items-center text-center overflow-hidden w-[350px]">
                    <div id="p1-name-container" class="flex items-baseline gap-3 whitespace-nowrap">
                        <span id="p1Sponsor" class="secondary-text"></span>
                        <span id="p1Tag" class="player-tag-text">Player 1</span>
                    </div>
                    <span id="p1Pronouns" class="secondary-text text-sm"></span>
                </div>
                <img id="p1Character" src="https://placehold.co/80x80/FF7300/FF7300?text=" class="h-[70px] w-auto ml-3">
            </div>
        </div>
        <!-- Player 2 -->
        <div class="h-full flex items-center">
             <div class="p2-bar h-[70px] flex items-center justify-center pl-4" style="width: 450px;">
                 <img id="p2Character" src="https://placehold.co/80x80/232323/232323?text=" class="h-[70px] w-auto mr-3">
                 <div class="flex flex-col items-center text-center overflow-hidden w-[350px]">
                    <div id="p2-name-container" class="flex items-baseline gap-3 whitespace-nowrap">
                        <span id="p2Sponsor" class="secondary-text"></span>
                        <span id="p2Tag" class="player-tag-text">Player 2</span>
                    </div>
                    <span id="p2Pronouns" class="secondary-text text-sm"></span>
                </div>
            </div>
            <div id="p2ScoreBox" class="score-box p2-score-box flex flex-col items-center justify-center">
                <span id="p2Score" class="text-4xl leading-none">0</span>
                <span id="p2Status" class="secondary-text"></span>
            </div>
        </div>
        <!-- Centerpiece -->
        <div class="absolute left-1/2 -translate-x-1/2 bottom-[-25px] z-10 flex flex-col items-center">
             <div class="center-logo"></div>
             <div class="match-info-box px-4 py-1 rounded-md text-center -mt-2">
                 <span id="round">Grand Finals</span> | <span id="format">Best of 5</span>
             </div>
        </div>
    </div>
    
    <div id="commentators" class="lower-third">
        <div id="comm1-box" class="commentator-box">
            <i class="fas fa-microphone text-2xl"></i>
            <div>
                <div id="commentator1Name" class="comm-name"></div>
                <div id="commentator1Social" class="comm-social"></div>
            </div>
        </div>
        <div id="comm2-box" class="commentator-box">
            <i class="fas fa-microphone text-2xl"></i>
            <div>
                <div id="commentator2Name" class="comm-name"></div>
                <div id="commentator2Social" class="comm-social"></div>
            </div>
        </div>
    </div>

    <div id="ticker" class="ticker">
        <div class="ticker-content text-2xl font-['Oswald']">
            <span id="tickerText"></span>
        </div>
    </div>
    
    <!-- NEW: VS SCREEN ELEMENT -->
    <div id="vs-screen">
        <div id="vs-player1" class="vs-player">
            <img id="vs-p1-char" src="" class="vs-char-render">
            <div class="vs-player-info">
                <div id="vs-p1-sponsor" class="vs-player-sponsor"></div>
                <div id="vs-p1-tag" class="vs-player-tag"></div>
            </div>
        </div>
        <div id="vs-text">VS</div>
        <div id="vs-player2" class="vs-player">
            <img id="vs-p2-char" src="" class="vs-char-render">
             <div class="vs-player-info">
                <div id="vs-p2-sponsor" class="vs-player-sponsor"></div>
                <div id="vs-p2-tag" class="vs-player-tag"></div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { firebaseConfig } from './firebase-config.js';

        const formatCharNameForFile = (name) => {
             if (!name) return '';
            switch (name) {
                case "Ice Climbers": return "IceClimbersPopo";
                case "Pyra and Mythra": return "Pyra";
                case "R.O.B.": return "Rob";
                case "Rosalina & Luma": return "Rosalina";
                case "Mr. Game & Watch": return "MrGame&Watch";
                default:
                    return name.replace(/\./g, '').replace(/ /g, '');
            }
        };
        // NEW: Mapping for full character renders
        const characterRenders = { "Mario": "mario", "Donkey Kong": "donkey_kong", "Link": "link", "Samus": "samus", "Dark Samus": "dark_samus", "Yoshi": "yoshi", "Kirby": "kirby", "Fox": "fox", "Pikachu": "pikachu", "Luigi": "luigi", "Ness": "ness", "Captain Falcon": "captain_falcon", "Jigglypuff": "jigglypuff", "Peach": "peach", "Daisy": "daisy", "Bowser": "bowser", "Ice Climbers": "ice_climbers", "Sheik": "sheik", "Zelda": "zelda", "Dr. Mario": "dr_mario", "Pichu": "pichu", "Falco": "falco", "Marth": "marth", "Lucina": "lucina", "Young Link": "young_link", "Ganondorf": "ganondorf", "Mewtwo": "mewtwo", "Roy": "roy", "Chrom": "chrom", "Mr. Game & Watch": "mr_game_watch", "Meta Knight": "meta_knight", "Pit": "pit", "Dark Pit": "dark_pit", "Zero Suit Samus": "zero_suit_samus", "Wario": "wario", "Snake": "snake", "Ike": "ike", "Pokemon Trainer": "pokemon_trainer", "Diddy Kong": "diddy_kong", "Lucas": "lucas", "Sonic": "sonic", "King Dedede": "king_dedede", "Olimar": "olimar", "Lucario": "lucario", "R.O.B.": "rob", "Toon Link": "toon_link", "Wolf": "wolf", "Villager": "villager", "Mega Man": "mega_man", "Wii Fit Trainer": "wii_fit_trainer", "Rosalina & Luma": "rosalina_and_luma", "Little Mac": "little_mac", "Greninja": "greninja", "Mii Brawler": "mii_brawler", "Mii Swordfighter": "mii_swordfighter", "Mii Gunner": "mii_gunner", "Palutena": "palutena", "Pac-Man": "pac_man", "Robin": "robin", "Shulk": "shulk", "Bowser Jr.": "bowser_jr", "Duck Hunt": "duck_hunt", "Ryu": "ryu", "Ken": "ken", "Cloud": "cloud", "Corrin": "corrin", "Bayonetta": "bayonetta", "Inkling": "inkling", "Ridley": "ridley", "Simon": "simon", "Richter": "richter", "King K. Rool": "king_k_rool", "Isabelle": "isabelle", "Incineroar": "incineroar", "Piranha Plant": "piranha_plant", "Joker": "joker", "Hero": "hero", "Banjo & Kazooie": "banjo_and_kazooie", "Terry": "terry", "Byleth": "byleth", "Min Min": "min_min", "Steve": "steve", "Sephiroth": "sephiroth", "Pyra and Mythra": "pyra_mythra", "Kazuya": "kazuya", "Sora": "sora" };
        const renderBaseUrl = "https://www.smashbros.com/assets_v2/img/fighter/";

        const stockIconBaseUrl = "https://raw.githubusercontent.com/destronfgc/stillwatersmash/main/images/stockicons/";
        let currentData = {};
        let vsScreenActive = false;

        const updateUIText = (data) => {
            document.body.dataset.theme = data.theme || 'osu';
            if (data.p1Score > (currentData.p1Score || 0)) animateScore('p1Score');
            if (data.p2Score > (currentData.p2Score || 0)) animateScore('p2Score');

            document.getElementById('p1Sponsor').textContent = data.p1Sponsor || '';
            document.getElementById('p1Tag').textContent = data.p1Tag || 'Player 1';
            document.getElementById('p1Pronouns').textContent = data.p1Pronouns || '';
            const p1StatusEl = document.getElementById('p1Status');
            p1StatusEl.textContent = data.p1Status || '';
            p1StatusEl.style.visibility = data.p1Status ? 'visible' : 'hidden';
            document.getElementById('p1Score').textContent = data.p1Score ?? 0;

            document.getElementById('p2Sponsor').textContent = data.p2Sponsor || '';
            document.getElementById('p2Tag').textContent = data.p2Tag || 'Player 2';
            document.getElementById('p2Pronouns').textContent = data.p2Pronouns || '';
            const p2StatusEl = document.getElementById('p2Status');
            p2StatusEl.textContent = data.p2Status || '';
            p2StatusEl.style.visibility = data.p2Status ? 'visible' : 'hidden';
            document.getElementById('p2Score').textContent = data.p2Score ?? 0;
            
            document.getElementById('round').textContent = data.round || 'Grand Finals';
            document.getElementById('format').textContent = `${data.formatPrefix || 'Best of'} ${data.formatNumber || 5}`;

            const p1CharFile = formatCharNameForFile(data.p1Character);
            const p1Alt = data.p1Alt || 1;
            document.getElementById('p1Character').src = p1CharFile ? `${stockIconBaseUrl}${p1CharFile}${p1Alt}.png` : 'https://placehold.co/80x80/FF7300/FF7300?text=';
            
            const p2CharFile = formatCharNameForFile(data.p2Character);
            const p2Alt = data.p2Alt || 1;
            document.getElementById('p2Character').src = p2CharFile ? `${stockIconBaseUrl}${p2CharFile}${p2Alt}.png` : 'https://placehold.co/80x80/232323/232323?text=';
            
            document.getElementById('commentator1Name').textContent = data.commentator1Name || '';
            document.getElementById('commentator1Social').textContent = data.commentator1Social || '';
            document.getElementById('commentator2Name').textContent = data.commentator2Name || '';
            document.getElementById('commentator2Social').textContent = data.commentator2Social || '';
            document.getElementById('tickerText').textContent = data.tickerText || '';

            document.getElementById('comm1-box').style.display = data.commentator1Name ? 'flex' : 'none';
            document.getElementById('comm2-box').style.display = data.commentator2Name ? 'flex' : 'none';

            document.getElementById('commentators').classList.toggle('visible', data.showCommentators);
            document.getElementById('ticker').classList.toggle('visible', data.showTicker);

            checkSetPoint(data);
            currentData = data;
        };
        
        const animateScore = (elementId) => {
            const el = document.getElementById(elementId);
            el.classList.add('score-updated');
            setTimeout(() => el.classList.remove('score-updated'), 400);
        };

        const checkSetPoint = (data) => {
            const formatPrefix = data.formatPrefix || 'Best of';
            const formatNumber = parseInt(data.formatNumber, 10) || 5;
            let winScore = (formatPrefix === 'Best of') ? Math.ceil(formatNumber / 2) : formatNumber;
            const p1ScoreBox = document.getElementById('p1ScoreBox');
            const p2ScoreBox = document.getElementById('p2ScoreBox');
            p1ScoreBox.classList.toggle('set-point', data.p1Score === winScore - 1 && winScore > 1);
            p2ScoreBox.classList.toggle('set-point', data.p2Score === winScore - 1 && winScore > 1);
        };

        const adjustPlayerFontSize = (playerId) => {
            const container = document.getElementById(`${playerId}-name-container`);
            const sponsor = document.getElementById(`${playerId}Sponsor`);
            const tag = document.getElementById(`${playerId}Tag`);
            const theme = document.body.dataset.theme;
            
            const maxTagSize = theme === 'remix' ? 2.5 : 2.2;
            const maxSponsorSize = theme === 'remix' ? 1.6 : 1.25;
            const minTagSize = 1.4; 
            const minSponsorSize = 0.9;
            const maxWidth = 350;

            tag.style.fontSize = `${maxTagSize}rem`;
            sponsor.style.fontSize = `${maxSponsorSize}rem`;

            setTimeout(() => {
                const currentWidth = container.scrollWidth;
                
                if (currentWidth > maxWidth) {
                    const scale = (maxWidth / currentWidth) * 0.98;
                    const newTagSize = Math.max(minTagSize, maxTagSize * scale);
                    const newSponsorSize = Math.max(minSponsorSize, maxSponsorSize * scale);
                    tag.style.fontSize = `${newTagSize}rem`;
                    sponsor.style.fontSize = `${newSponsorSize}rem`;
                }
                else {
                    tag.style.fontSize = `${maxTagSize}rem`;
                    sponsor.style.fontSize = `${maxSponsorSize}rem`;
                }
            }, 50);
        };
        
        // --- NEW: VS SCREEN LOGIC ---
        const triggerVsScreen = async (data, docRef) => {
            if (vsScreenActive) return;
            vsScreenActive = true;

            // 1. Populate VS screen with data
            const p1RenderSlug = characterRenders[data.p1Character];
            const p2RenderSlug = characterRenders[data.p2Character];
            
            document.getElementById('vs-p1-char').src = p1RenderSlug ? `${renderBaseUrl}${p1RenderSlug}/main.png` : '';
            document.getElementById('vs-p2-char').src = p2RenderSlug ? `${renderBaseUrl}${p2RenderSlug}/main.png` : '';

            document.getElementById('vs-p1-sponsor').textContent = data.p1Sponsor || '';
            document.getElementById('vs-p1-tag').textContent = data.p1Tag || 'Player 1';
            document.getElementById('vs-p2-sponsor').textContent = data.p2Sponsor || '';
            document.getElementById('vs-p2-tag').textContent = data.p2Tag || 'Player 2';
            
            // 2. Show the screen
            const vsScreen = document.getElementById('vs-screen');
            vsScreen.classList.add('visible');

            // 3. Hide the screen after a delay
            setTimeout(() => {
                vsScreen.classList.remove('visible');
                // Reset the trigger in the database
                updateDoc(docRef, { showVsScreen: false });
                vsScreenActive = false;
            }, 6000); // Show for 6 seconds
        };


        const main = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                const appId = 'stillwater-smash-overlay'; 
                const docRef = doc(db, 'overlays', appId);

                onSnapshot(docRef, (doc) => {
                    const data = doc.exists() ? doc.data() : {};
                    updateUIText(data);
                    adjustPlayerFontSize('p1');
                    adjustPlayerFontSize('p2');

                    // Check for the VS screen trigger
                    if (data.showVsScreen && !vsScreenActive) {
                        triggerVsScreen(data, docRef);
                    }
                });
            } catch (error) {
                console.error("OVERLAY FAILED TO CONNECT:", error);
            }
        };

        main();
    </script>
</body>
</html>


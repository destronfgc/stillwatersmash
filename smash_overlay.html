<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smash Bros. Ultimate OBS Overlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: transparent;
            font-family: 'Roboto Slab', serif;
            color: white;
            overflow: hidden;
            width: 1920px;
            height: 1080px;
        }
        .player-tag-text {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            font-weight: 700;
            font-size: 2.2rem;
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000;
            transition: font-size 0.2s ease-in-out;
        }
        .secondary-text {
            font-family: 'Roboto Slab', serif;
            text-transform: uppercase;
            font-size: 1.25rem; /* Increased size for visibility */
            letter-spacing: 0.05em;
            transition: font-size 0.2s ease-in-out;
            /* Added subtle shadow for better visibility */
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
        /* Overriding shadow for better contrast on different backgrounds */
        .p1-bar .secondary-text { color: #E5E7EB; } 
        .p2-bar .secondary-text { color: #D1D5DB; } 
        
        .score-box {
            background-color: white;
            color: #FF7300; /* OSU Orange */
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            width: 80px;
            height: 80px;
        }
        .p1-score-box { clip-path: polygon(0 0, 100% 0, 100% 100%, 25% 100%, 0 75%); }
        .p2-score-box { clip-path: polygon(0 0, 100% 0, 100% 75%, 75% 100%, 0 100%); }
        .p1-bar { background-color: #FF7300; }
        .p2-bar { background-color: #232323; border: 2px solid #555; }

        .center-logo {
            width: 110px;
            height: 110px;
            background-color: white;
            border-radius: 50%;
            border: 8px solid #FF7300;
            background-image: url('https://raw.githubusercontent.com/destronfgc/stillwatersmash/main/images/shieldpokeslogo.png');
            background-size: 115%; 
            background-position: center;
            background-repeat: no-repeat;
        }

        .match-info-box {
            background-color: white;
            color: #232323;
            font-family: 'Oswald', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="flex items-start justify-center pt-8">

    <div class="w-[1200px] h-[120px] flex items-center justify-between relative">
        
        <div class="h-full flex items-center">
            <div class="score-box p1-score-box flex flex-col items-center justify-center">
                <span id="p1Score" class="text-4xl leading-none">0</span>
                <span id="p1Status" class="secondary-text text-black text-xs -mt-1" style="text-shadow: none;">Winners</span>
            </div>
            <div class="p1-bar h-[70px] flex items-center justify-end pr-4" style="width: 450px;">
                <div class="flex flex-col items-end text-right overflow-hidden">
                    <div id="p1-name-container" class="flex items-baseline gap-3 whitespace-nowrap">
                        <span id="p1Sponsor" class="secondary-text"></span>
                        <span id="p1Tag" class="player-tag-text">Player 1</span>
                    </div>
                    <span id="p1Pronouns" class="secondary-text text-sm"></span>
                </div>
                <img id="p1Character" src="https://placehold.co/80x80/FF7300/FF7300?text=" class="h-[70px] w-auto ml-3">
            </div>
        </div>
        
        <div class="h-full flex items-center">
             <div class="p2-bar h-[70px] flex items-center justify-start pl-4" style="width: 450px;">
                 <img id="p2Character" src="https://placehold.co/80x80/232323/232323?text=" class="h-[70px] w-auto mr-3">
                 <div class="flex flex-col items-start text-left overflow-hidden">
                    <div id="p2-name-container" class="flex items-baseline gap-3 whitespace-nowrap">
                        <span id="p2Sponsor" class="secondary-text"></span>
                        <span id="p2Tag" class="player-tag-text">Player 2</span>
                    </div>
                    <span id="p2Pronouns" class="secondary-text text-sm"></span>
                </div>
            </div>
            <div class="score-box p2-score-box flex flex-col items-center justify-center">
                <span id="p2Score" class="text-4xl leading-none">0</span>
                <span id="p2Status" class="secondary-text text-black text-xs -mt-1" style="text-shadow: none;">Losers</span>
            </div>
        </div>

        <div class="absolute left-1/2 -translate-x-1/2 bottom-[-25px] z-10 flex flex-col items-center">
             <div class="center-logo"></div>
             <div class="match-info-box px-4 py-1 rounded-md text-center -mt-2">
                 <span id="round">Grand Finals</span> | <span id="format">Best of 5</span>
             </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { firebaseConfig } from './firebase-config.js';

        const characters = {
            "Banjo & Kazooie": "Banjo_&_Kazooie", "Bayonetta": "Bayonetta", "Bowser": "Bowser", "Bowser Jr.": "Bowser_Jr",
            "Byleth": "Byleth", "Captain Falcon": "Captain_Falcon", "Chrom": "Chrom", "Cloud": "Cloud", "Corrin": "Corrin",
            "Daisy": "Daisy", "Dark Pit": "Dark_Pit", "Dark Samus": "Dark_Samus", "Diddy Kong": "Diddy_Kong",
            "Donkey Kong": "Donkey_Kong", "Dr. Mario": "Dr_Mario", "Duck Hunt": "Duck_Hunt", "Falco": "Falco",
            "Fox": "Fox", "Ganondorf": "Ganondorf", "Greninja": "Greninja", "Hero": "Hero", "Ice Climbers": "Ice_Climbers",
            "Ike": "Ike", "Incineroar": "Incineroar", "Inkling": "Inkling", "Isabelle": "Isabelle", "Jigglypuff": "Jigglypuff",
            "Joker": "Joker", "Kazuya": "Kazuya", "Ken": "Ken", "King Dedede": "King_Dedede", "King K. Rool": "King_K_Rool",
            "Kirby": "Kirby", "Link": "Link", "Little Mac": "Little_Mac", "Lucario": "Lucario", "Lucas": "Lucas",
            "Lucina": "Lucina", "Luigi": "Luigi", "Mario": "Mario", "Marth": "Marth", "Mega Man": "Mega_Man",
            "Meta Knight": "Meta_Knight", "Mewtwo": "Mewtwo", "Mii Brawler": "Mii_Brawler", "Mii Gunner": "Mii_Gunner",
            "Mii Swordfighter": "Mii_Swordfighter", "Min Min": "Min_Min", "Mr. Game & Watch": "Mr_Game_&_Watch",
            "Ness": "Ness", "Olimar": "Olimar", "Pac-Man": "Pac-Man", "Palutena": "Palutena", "Peach": "Peach",
            "Pichu": "Pichu", "Pikachu": "Pikachu", "Piranha Plant": "Piranha_Plant", "Pit": "Pit",
            "Pyra and Mythra": "Pyra_Mythra", "Richter": "Richter", "Ridley": "Ridley", "R.O.B.": "ROB",
            "Robin": "Robin", "Rosalina & Luma": "Rosalina_&_Luma", "Roy": "Roy", "Ryu": "Ryu", "Samus": "Samus",
            "Sephiroth": "Sephiroth", "Sheik": "Sheik", "Shulk": "Shulk", "Simon": "Simon", "Snake": "Snake",
            "Sora": "Sora", "Sonic": "Sonic", "Steve": "Steve", "Terry": "Terry", "Toon Link": "Toon_Link",
            "Villager": "Villager", "Wario": "Wario", "Wii Fit Trainer": "Wii_Fit_Trainer", "Wolf": "Wolf",
            "Yoshi": "Yoshi", "Young Link": "Young_Link", "Zelda": "Zelda", "Zero Suit Samus": "Zero_Suit_Samus"
        };
        const stockIconBaseUrl = "https://www.ssbwiki.com/images/stock/ssbu/";

        const updateUI = (data) => {
            document.getElementById('p1Sponsor').textContent = data.p1Sponsor || '';
            document.getElementById('p1Tag').textContent = data.p1Tag || 'Player 1';
            document.getElementById('p1Pronouns').textContent = data.p1Pronouns || '';
            document.getElementById('p1Status').textContent = data.p1Status || 'Winners';
            document.getElementById('p1Score').textContent = data.p1Score ?? 0;

            document.getElementById('p2Sponsor').textContent = data.p2Sponsor || '';
            document.getElementById('p2Tag').textContent = data.p2Tag || 'Player 2';
            document.getElementById('p2Pronouns').textContent = data.p2Pronouns || '';
            document.getElementById('p2Status').textContent = data.p2Status || 'Losers';
            document.getElementById('p2Score').textContent = data.p2Score ?? 0;
            
            document.getElementById('round').textContent = data.round || 'Grand Finals';
            document.getElementById('format').textContent = `${data.formatPrefix || 'Best of'} ${data.formatNumber || 5}`;

            const p1CharFile = characters[data.p1Character];
            document.getElementById('p1Character').src = p1CharFile ? `${stockIconBaseUrl}${p1CharFile}.png` : 'https://placehold.co/80x80/FF7300/FF7300?text=';
            
            const p2CharFile = characters[data.p2Character];
            document.getElementById('p2Character').src = p2CharFile ? `${stockIconBaseUrl}${p2CharFile}.png` : 'https://placehold.co/80x80/232323/232323?text=';

            requestAnimationFrame(() => {
                adjustFontSize('p1-name-container');
                adjustFontSize('p2-name-container');
            });
        };
        
        // This new function reduces font size until the text fits, which is more reliable.
        const adjustFontSize = (containerId) => {
            const container = document.getElementById(containerId);
            const sponsor = container.querySelector('#' + containerId.replace('-name-container', 'Sponsor'));
            const tag = container.querySelector('#' + containerId.replace('-name-container', 'Tag'));
            
            // Set initial sizes
            let tagSize = 2.2;
            let sponsorSize = 1.25;
            tag.style.fontSize = `${tagSize}rem`;
            sponsor.style.fontSize = `${sponsorSize}rem`;

            const maxWidth = 350; 

            // Use a loop to check width and reduce size if needed
            requestAnimationFrame(() => {
                 while (container.scrollWidth > maxWidth && tagSize > 1.0) {
                    tagSize -= 0.1;
                    sponsorSize -= 0.05;
                    tag.style.fontSize = `${tagSize}rem`;
                    sponsor.style.fontSize = `${sponsorSize}rem`;
                }
            });
        };


        const main = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                await signInAnonymously(auth);

                const appId = 'stillwater-smash-overlay'; 
                const docRef = doc(db, 'overlays', appId);

                onSnapshot(docRef, (doc) => {
                    updateUI(doc.exists() ? doc.data() : {});
                });
            } catch (error) {
                console.error("OVERLAY FAILED TO CONNECT:", error);
            }
        };

        main();
    </script>
</body>
</html>

